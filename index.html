<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/blog/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/blog/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />




  


  <link rel="alternate" href="/blog/atom.xml" title="渣渣程序员" type="application/atom+xml" />






<meta property="og:type" content="website">
<meta property="og:title" content="渣渣程序员">
<meta property="og:url" content="https://github.com/liututu1213/liututu1213.github.io/blog/index.html">
<meta property="og:site_name" content="渣渣程序员">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="liututu1213">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://github.com/liututu1213/liututu1213.github.io/blog/"/>





  <title>渣渣程序员</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">渣渣程序员</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/liututu1213/liututu1213.github.io/blog/blog/posts/2020/02/26/Moya/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liututu1213">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="渣渣程序员">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/posts/2020/02/26/Moya/" itemprop="url">Moya && Alamofire</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-26T00:05:39+08:00">
                2020-02-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/swift/" itemprop="url" rel="index">
                    <span itemprop="name">swift</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>对Moya和Alamofire的分析基于以下版本：Alamofire (4.9.1) 、Moya (13.0.1)。</p>
<h2 id="Moya"><a href="#Moya" class="headerlink" title="Moya"></a>Moya</h2><p>Moya的目录结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">├── Moya</span><br><span class="line">│   ├── AnyEncodable.swift</span><br><span class="line">│   ├── Cancellable.swift</span><br><span class="line">│   ├── Endpoint.swift</span><br><span class="line">│   ├── Image.swift</span><br><span class="line">│   ├── Moya+Alamofire.swift</span><br><span class="line">│   ├── MoyaError.swift</span><br><span class="line">│   ├── MoyaProvider+Defaults.swift</span><br><span class="line">│   ├── MoyaProvider+Internal.swift</span><br><span class="line">│   ├── MoyaProvider.swift</span><br><span class="line">│   ├── MultiTarget.swift</span><br><span class="line">│   ├── MultipartFormData.swift</span><br><span class="line">│   ├── Plugin.swift</span><br><span class="line">│   ├── Plugins</span><br><span class="line">│   │   ├── AccessTokenPlugin.swift</span><br><span class="line">│   │   ├── CredentialsPlugin.swift</span><br><span class="line">│   │   ├── NetworkActivityPlugin.swift</span><br><span class="line">│   │   └── NetworkLoggerPlugin.swift</span><br><span class="line">│   ├── Response.swift</span><br><span class="line">│   ├── TargetType.swift</span><br><span class="line">│   ├── Task.swift</span><br><span class="line">│   ├── URL+Moya.swift</span><br><span class="line">│   ├── URLRequest+Encoding.swift</span><br><span class="line">│   └── ValidationType.swift</span><br><span class="line">├── ReactiveMoya</span><br><span class="line">│   ├── MoyaProvider+Reactive.swift</span><br><span class="line">│   └── SignalProducer+Response.swift</span><br><span class="line">└── RxMoya</span><br><span class="line">    ├── MoyaProvider+Rx.swift</span><br><span class="line">    ├── Observable+Response.swift</span><br><span class="line">    └── Single+Response.swift</span><br></pre></td></tr></table></figure>



<h3 id="Moya介绍"><a href="#Moya介绍" class="headerlink" title="Moya介绍"></a>Moya介绍</h3><p>Moya是基于Alamofire的更高一层的网络请求封装抽象层，在Moya中使用Enum来管理API，每一个网络请求接口都是枚举的一种case，下面是Moya的大概流程图：</p>
<p><img src="https://raw.githubusercontent.com/liututu1213/imageForSource/master/2020/moya.png" alt=""></p>
<h3 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h3><p>request部分主要是包含请求相关的代码，定义了TargetType协议，通过TargetType来定义一个请求。</p>
<ul>
<li>TargetType:请求相关信息</li>
<li>Endpoint：Moya进行请求的最终数据结构</li>
<li>Task：定义了请求的发起方式，请求参数设置等</li>
<li>Cancellable：请求取消相关协议</li>
</ul>
<h3 id="MoyaProvider"><a href="#MoyaProvider" class="headerlink" title="MoyaProvider"></a>MoyaProvider</h3><h4 id="Provider初始化"><a href="#Provider初始化" class="headerlink" title="Provider初始化"></a>Provider初始化</h4><p>MoyaProvider是Moya的核心处理类，Moya中所有的API请求都是通过Provider来发起的。Provider真正做的事情可以用一个流来表示：Target-&gt;Endpoint-&gt;Request,这个过程中Provider会一步步生层一个NSURLRequest来交给Alamofire发起请求。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(endpointClosure: @escaping <span class="type">EndpointClosure</span> = <span class="type">MoyaProvider</span>.defaultEndpointMapping,</span><br><span class="line">            requestClosure: @escaping <span class="type">RequestClosure</span> = <span class="type">MoyaProvider</span>.defaultRequestMapping,</span><br><span class="line">            stubClosure: @escaping <span class="type">StubClosure</span> = <span class="type">MoyaProvider</span>.neverStub,</span><br><span class="line">            callbackQueue: <span class="type">DispatchQueue?</span> = <span class="literal">nil</span>,</span><br><span class="line">            manager: <span class="type">Manager</span> = <span class="type">MoyaProvider</span>&lt;<span class="type">Target</span>&gt;.defaultAlamofireManager(),</span><br><span class="line">            plugins: [<span class="type">PluginType</span>] = [],</span><br><span class="line">            trackInflights: <span class="type">Bool</span> = <span class="literal">false</span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>endpointClosure：负责从TargetType转成Endpoint，Moya对endpointClosure提供了默认的实现。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">defaultEndpointMapping</span>(<span class="title">for</span> <span class="title">target</span>: <span class="title">Target</span>) -&gt; <span class="title">Endpoint</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Endpoint</span>(</span><br><span class="line">        url: <span class="type">URL</span>(target: target).absoluteString,</span><br><span class="line">        sampleResponseClosure: &#123; .networkResponse(<span class="number">200</span>, target.sampleData) &#125;,</span><br><span class="line">        method: target.method,</span><br><span class="line">        task: target.task,</span><br><span class="line">        httpHeaderFields: target.headers</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在实际的项目中，可以自定义这个闭包来实现复杂的功能。</p>
</li>
</ul>
<ul>
<li><p>requestClosure：负责把Endpoint转换成NSURLRequest，同样也有默认的实现<code>MoyaProvider.defaultRequestMappin</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">defaultRequestMapping</span>(<span class="title">for</span> <span class="title">endpoint</span>: <span class="title">Endpoint</span>, <span class="title">closure</span>: <span class="title">RequestResultClosure</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> urlRequest = <span class="keyword">try</span> endpoint.urlRequest()</span><br><span class="line">        closure(.success(urlRequest))</span><br><span class="line">    &#125; <span class="keyword">catch</span> <span class="type">MoyaError</span>.requestMapping(<span class="keyword">let</span> url) &#123;</span><br><span class="line">        closure(.failure(<span class="type">MoyaError</span>.requestMapping(url)))</span><br><span class="line">    &#125; <span class="keyword">catch</span> <span class="type">MoyaError</span>.parameterEncoding(<span class="keyword">let</span> error) &#123;</span><br><span class="line">        closure(.failure(<span class="type">MoyaError</span>.parameterEncoding(error)))</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        closure(.failure(<span class="type">MoyaError</span>.underlying(error, <span class="literal">nil</span>)))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>stubClosure：返回一个枚举StubBehavior，默认会返回never，如果需要假数据测试可以重写这个。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">StubBehavior</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> never</span><br><span class="line">    <span class="keyword">case</span> immediate</span><br><span class="line">    <span class="keyword">case</span> delayed(seconds: <span class="type">TimeInterval</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>callbackQueue： 回调的线程，默认在主线程。</p>
</li>
<li><p>manager：真正用来请求的类，由Alamofire桥接过来的，Moya提供了一个默认的Manager实现。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">defaultAlamofireManager</span>() -&gt; <span class="title">Manager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> configuration = <span class="type">URLSessionConfiguration</span>.<span class="keyword">default</span></span><br><span class="line">    configuration.httpAdditionalHeaders = <span class="type">Manager</span>.defaultHTTPHeaders</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> manager = <span class="type">Manager</span>(configuration: configuration)</span><br><span class="line">    manager.startRequestsImmediately = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> manager</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li>plugins：插件，能够在不修改源码的情况下，来扩展其他功能，而且能够保证Provider的职责单一，满足开闭原则。</li>
<li>trackInflights：是否要追踪请求，默认是false。</li>
</ul>
<h4 id="Provider-发起请求实现"><a href="#Provider-发起请求实现" class="headerlink" title="Provider 发起请求实现"></a>Provider 发起请求实现</h4><p><img src="https://raw.githubusercontent.com/liututu1213/imageForSource/master/2020/Provider.png" alt=""></p>
<p>在初始化Provider实例对象之后，对外暴露<code>request</code>方法以便发起请求：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@discardableResult</span></span><br><span class="line"><span class="keyword">open</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> target: Target,</span></span></span><br><span class="line"><span class="function"><span class="params">                  callbackQueue: DispatchQueue? = .<span class="keyword">none</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                  progress: ProgressBlock? = .<span class="keyword">none</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                  completion: @escaping Completion)</span></span> -&gt; <span class="type">Cancellable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> callbackQueue = callbackQueue ?? <span class="keyword">self</span>.callbackQueue</span><br><span class="line">    <span class="keyword">return</span> requestNormal(target, callbackQueue: callbackQueue, progress: progress, completion: completion)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在swift里面，如果没有接收某方法的返回值，Xcode会报出警告，使用<code>@discardableResult</code>关键字在不想接收方法返回值的时候，用来消除Xcode的警告。</p>
<p>在MoyaProvider+Internal.swift文件中主要定义了十个方法,主要做的事如下图：</p>
<p><img src="https://raw.githubusercontent.com/liututu1213/imageForSource/master/2020/provider-rquest.png" alt=""></p>
<h3 id="Moya-Alamofire"><a href="#Moya-Alamofire" class="headerlink" title="Moya+Alamofire"></a>Moya+Alamofire</h3><p>Moya+Alamofire.swift文件对Alamofire进行了简单的封装，这一层包装隔离了Alamofire的代码，如果需要更换请求框架的话，可以进行简单的修改来替换。</p>
<ul>
<li><p>使用<strong>typealias</strong>对Alamofire相关的的API进行封装：Manager、Request、Method等</p>
</li>
<li><p>让Alamofire相关的类实现Moya定义的一些protocol</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Request</span>: <span class="title">RequestType</span> </span>&#123; &#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">DataRequest</span>: <span class="title">Requestable</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">DownloadRequest</span>: <span class="title">Requestable</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="Plugin"><a href="#Plugin" class="headerlink" title="Plugin"></a>Plugin</h3><p>Moya提供了非常好用的插件机制，可以通过插件在不修改源码的基础上，充分扩展Moya的功能。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">PluginType</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// Called to modify a request before sending.</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">(<span class="number">_</span> request: URLRequest, target: TargetType)</span></span> -&gt; <span class="type">URLRequest</span></span><br><span class="line">    <span class="comment">/// Called immediately before a request is sent over the network (or stubbed).</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">willSend</span><span class="params">(<span class="number">_</span> request: RequestType, target: TargetType)</span></span></span><br><span class="line">    <span class="comment">/// Called after a response has been received, but before the MoyaProvider has invoked its completion handler.</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">didReceive</span><span class="params">(<span class="number">_</span> result: Result&lt;Moya.Response, MoyaError&gt;, target: TargetType)</span></span></span><br><span class="line">    <span class="comment">/// Called to modify a result before completion.</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(<span class="number">_</span> result: Result&lt;Moya.Response, MoyaError&gt;, target: TargetType)</span></span> -&gt; <span class="type">Result</span>&lt;<span class="type">Moya</span>.<span class="type">Response</span>, <span class="type">MoyaError</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">extension</span> <span class="title">PluginType</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">(<span class="number">_</span> request: URLRequest, target: TargetType)</span></span> -&gt; <span class="type">URLRequest</span> &#123; <span class="keyword">return</span> request &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">willSend</span><span class="params">(<span class="number">_</span> request: RequestType, target: TargetType)</span></span> &#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">didReceive</span><span class="params">(<span class="number">_</span> result: Result&lt;Moya.Response, MoyaError&gt;, target: TargetType)</span></span> &#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(<span class="number">_</span> result: Result&lt;Moya.Response, MoyaError&gt;, target: TargetType)</span></span> -&gt; <span class="type">Result</span>&lt;<span class="type">Moya</span>.<span class="type">Response</span>, <span class="type">MoyaError</span>&gt; &#123; <span class="keyword">return</span> result &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用方可以实现上面的协议，来创建各种插件处理不同事情，从而保证Provider的单一职责。</p>
<ul>
<li><p>prepare：这个方法会在endpoint生成Request之后且请求发送前调用</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> performNetworking = &#123; (requestResult: <span class="type">Result</span>&lt;<span class="type">URLRequest</span>, <span class="type">MoyaError</span>&gt;) <span class="keyword">in</span></span><br><span class="line">    <span class="comment">// Allow plugins to modify request</span></span><br><span class="line">    <span class="keyword">let</span> preparedRequest = <span class="keyword">self</span>.plugins.<span class="built_in">reduce</span>(request) &#123; $<span class="number">1</span>.prepare($<span class="number">0</span>, target: target) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>willSend：会在发送Alamofire请求前调用</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendAlamofireRequest</span>&lt;T&gt;<span class="params">(<span class="number">_</span> alamoRequest: T, target: Target, callbackQueue: DispatchQueue?, progress progressCompletion: Moya.ProgressBlock?, completion: @escaping Moya.Completion)</span></span> -&gt; <span class="type">CancellableToken</span> <span class="keyword">where</span> <span class="type">T</span>: <span class="type">Requestable</span>, <span class="type">T</span>: <span class="type">Request</span> &#123;</span><br><span class="line">    <span class="comment">// Give plugins the chance to alter the outgoing request</span></span><br><span class="line">    <span class="keyword">let</span> plugins = <span class="keyword">self</span>.plugins</span><br><span class="line">    plugins.forEach &#123; $<span class="number">0</span>.willSend(alamoRequest, target: target) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>didReceive：在收到Response的时候调用</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> completionHandler: <span class="type">RequestableCompletion</span> = &#123; response, request, data, error <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">let</span> result = convertResponseToResult(response, request: request, data: data, error: error)</span><br><span class="line">    <span class="comment">// Inform all plugins about the response</span></span><br><span class="line">    plugins.forEach &#123; $<span class="number">0</span>.didReceive(result, target: target) &#125;</span><br><span class="line">    completion(result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>process：在请求完成后修改Result。</p>
</li>
</ul>
<h3 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h3><p>响应结果相关方法，以及字典，JSON等相关转换方法。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Represents a response to a `MoyaProvider.request`.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span>: <span class="title">CustomDebugStringConvertible</span>, <span class="title">Equatable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> statusCode: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> data: <span class="type">Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> request: <span class="type">URLRequest?</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">let</span> response: <span class="type">HTTPURLResponse?</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="Cancel"><a href="#Cancel" class="headerlink" title="Cancel"></a>Cancel</h4><p>网络API请求是 可以被取消的，Moya返回协议Cancellable给客户端。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">CancellableWrapper</span>: <span class="title">Cancellable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> innerCancellable: <span class="type">Cancellable</span> = <span class="type">SimpleCancellable</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> isCancelled: <span class="type">Bool</span> &#123; <span class="keyword">return</span> innerCancellable.isCancelled &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">func</span> <span class="title">cancel</span><span class="params">()</span></span> &#123;</span><br><span class="line">        innerCancellable.cancel()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在内部实现中，引入了一个CancellableWrapper来进行实际的Cancel包装，返回的实际实现协议的类型就是它。</p>
<p>使用一个CancellableWrapper包装的原因主要是对于没有实际发出的请求(参数错误)，cancel动作直接用SimpleCancellable即可，如果已经发出的请求，cancel则需要取消实际的网络请求。</p>
<p>在<code>CancellableToken</code>中，取消网络请求：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CancellableToken</span>: <span class="title">Cancellable</span>, <span class="title">CustomDebugStringConvertible</span> </span>&#123;</span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">var</span> lock: <span class="type">DispatchSemaphore</span> = <span class="type">DispatchSemaphore</span>(value: <span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">cancel</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="number">_</span> = lock.wait(timeout: <span class="type">DispatchTime</span>.distantFuture)</span><br><span class="line">        <span class="keyword">defer</span> &#123; lock.signal() &#125;</span><br><span class="line">        <span class="keyword">guard</span> !isCancelled <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        isCancelled = <span class="literal">true</span></span><br><span class="line">        cancelAction()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">init</span>(request: <span class="type">Request</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.request = request</span><br><span class="line">        <span class="keyword">self</span>.cancelAction = &#123;</span><br><span class="line">            request.cancel()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里用到了信号量，为了防止两个线程同时执行cancel操作。</p>
<h3 id="Moya的设计原则"><a href="#Moya的设计原则" class="headerlink" title="Moya的设计原则"></a>Moya的设计原则</h3><p>1.面向协议</p>
<p>swift是一个面向协议的语言，协议建立的是一个抽象的依赖关系，同时Swift协议支持扩展，可以通过扩展为协议中的方法提供默认的实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public protocol TargetType &#123;&#125; &#x2F;&#x2F;表示一个API请求</span><br><span class="line">public protocol Cancellable &#123;&#125; &#x2F;&#x2F; 唯一确定请求，只有一个接口用力爱取消</span><br><span class="line">public protocol PluginType &#123;&#125; &#x2F;&#x2F; 插件类型</span><br><span class="line">public protocol RequestType &#123;&#125; &#x2F;&#x2F; 对外提供的请求类型，隐藏Alamofire的细节</span><br></pre></td></tr></table></figure>



<p>2.不可变状态</p>
<p>不可变状态是函数式编程的一个核心概念，在Moya中，很多状态都是不可变的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public protocol TargetType &#123;</span><br><span class="line">    var baseURL: URL &#123; get &#125; &#x2F;&#x2F; 只读</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.高阶函数</p>
<p>在swift中，函数是一等公民，可以作为函数的参数和返回值。高阶函数配合函数默认值，是swift开发中进行接口暴露的常用技巧。</p>
<p>4.插件</p>
<p>通过各个节点暴露出插件的接口，让Moya的日志、授权等功能无须耦合到核心代码里，让代码足够灵活性。</p>
<p>5.类型安全</p>
<p>使用枚举来保证类型安全是swift中常用的技巧。</p>
<p>6.错误处理</p>
<p>通过Result类型来处理异步错误。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A public function responsible for converting the result of a `URLRequest` to a Result&lt;Moya.Response, MoyaError&gt;.</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">convertResponseToResult</span><span class="params">(<span class="number">_</span> response: HTTPURLResponse?, request: URLRequest?, data: Data?, error: Swift.Error?)</span></span> -&gt;</span><br><span class="line">    <span class="type">Result</span>&lt;<span class="type">Moya</span>.<span class="type">Response</span>, <span class="type">MoyaError</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">switch</span> (response, data, error) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> (.some(response), data, .<span class="keyword">none</span>):</span><br><span class="line">            <span class="keyword">let</span> response = <span class="type">Moya</span>.<span class="type">Response</span>(statusCode: response.statusCode, data: data ?? <span class="type">Data</span>(), request: request, response: response)</span><br><span class="line">            <span class="keyword">return</span> .success(response)</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> (.some(response), <span class="number">_</span>, .some(error)):</span><br><span class="line">            <span class="keyword">let</span> response = <span class="type">Moya</span>.<span class="type">Response</span>(statusCode: response.statusCode, data: data ?? <span class="type">Data</span>(), request: request, response: response)</span><br><span class="line">            <span class="keyword">let</span> error = <span class="type">MoyaError</span>.underlying(error, response)</span><br><span class="line">            <span class="keyword">return</span> .failure(error)</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> (<span class="number">_</span>, <span class="number">_</span>, .some(error)):</span><br><span class="line">            <span class="keyword">let</span> error = <span class="type">MoyaError</span>.underlying(error, <span class="literal">nil</span>)</span><br><span class="line">            <span class="keyword">return</span> .failure(error)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">let</span> error = <span class="type">MoyaError</span>.underlying(<span class="type">NSError</span>(domain: <span class="type">NSURLErrorDomain</span>, code: <span class="type">NSURLErrorUnknown</span>, userInfo: <span class="literal">nil</span>), <span class="literal">nil</span>)</span><br><span class="line">            <span class="keyword">return</span> .failure(error)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用Result类型最大的好处是可以不用每一步都处理错误，通过Result类型，可以在最后统一处理错误。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">provider.request(...).filter().mapJSON.filter().&#123; result in</span><br><span class="line">    switch result &#123;</span><br><span class="line">        case let .success(moyaResponse):</span><br><span class="line">    </span><br><span class="line">        case let .failure(error):</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>





<h2 id="Alamofire"><a href="#Alamofire" class="headerlink" title="Alamofire"></a>Alamofire</h2><p>Alamofire的目录结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">├── AFError.swift</span><br><span class="line">├── Alamofire.swift</span><br><span class="line">├── DispatchQueue+Alamofire.swift</span><br><span class="line">├── MultipartFormData.swift</span><br><span class="line">├── NetworkReachabilityManager.swift</span><br><span class="line">├── Notifications.swift</span><br><span class="line">├── ParameterEncoding.swift</span><br><span class="line">├── Request.swift</span><br><span class="line">├── Response.swift</span><br><span class="line">├── ResponseSerialization.swift</span><br><span class="line">├── Result.swift</span><br><span class="line">├── ServerTrustPolicy.swift</span><br><span class="line">├── SessionDelegate.swift</span><br><span class="line">├── SessionManager.swift</span><br><span class="line">├── TaskDelegate.swift</span><br><span class="line">├── Timeline.swift</span><br><span class="line">└── Validation.swift</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/liututu1213/imageForSource/master/2020/Alamofire.png" alt=""></p>
<h3 id="Alamofire-swift"><a href="#Alamofire-swift" class="headerlink" title="Alamofire.swift"></a>Alamofire.swift</h3><p>该文件主要是给用户提供一些便利的调用方法<code>request</code>、<code>download</code>、<code>upload</code>、<code>stream</code>，以及定义了两个protocol接口，提供将其他类型转换成URL和URLRequest。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@discardableResult</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="number">_</span> url: URLConvertible,</span></span></span><br><span class="line"><span class="function"><span class="params">    method: HTTPMethod = .<span class="keyword">get</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    parameters: Parameters? = <span class="literal">nil</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    encoding: ParameterEncoding = URLEncoding.<span class="keyword">default</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    headers: HTTPHeaders? = <span class="literal">nil</span>)</span></span></span><br><span class="line">    -&gt; <span class="type">DataRequest</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">SessionManager</span>.<span class="keyword">default</span>.request(</span><br><span class="line">        url,</span><br><span class="line">        method: method,</span><br><span class="line">        parameters: parameters,</span><br><span class="line">        encoding: encoding,</span><br><span class="line">        headers: headers</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@discardableResult</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> urlRequest: URLRequestConvertible)</span></span> -&gt; <span class="type">DataRequest</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">SessionManager</span>.<span class="keyword">default</span>.request(urlRequest)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//....</span></span><br></pre></td></tr></table></figure>

<p>上面是提供给外部发起网络请求的api。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">URLConvertible</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">asURL</span><span class="params">()</span></span> <span class="keyword">throws</span> -&gt; <span class="type">URL</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">URLRequestConvertible</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">asURLRequest</span><span class="params">()</span></span> <span class="keyword">throws</span> -&gt; <span class="type">URLRequest</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个两个protocol主要是负责类型转换的接口。</p>
<h3 id="SessionManager"><a href="#SessionManager" class="headerlink" title="SessionManager"></a>SessionManager</h3><h4 id="1-SessionManager的初始化"><a href="#1-SessionManager的初始化" class="headerlink" title="1.SessionManager的初始化"></a>1.SessionManager的初始化</h4><p>上面的便利方法主要是调用Manager类的单利，Manager类中主要负责Session和Request的初始化，并提供SessionDelegate代理方法的默认实现。在实现代理方法时提供相应的闭包以提供给用户使用该闭包来回调相应的代理方法。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">let</span> `<span class="keyword">default</span>`: <span class="type">SessionManager</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> configuration = <span class="type">URLSessionConfiguration</span>.<span class="keyword">default</span></span><br><span class="line">    configuration.httpAdditionalHeaders = <span class="type">SessionManager</span>.defaultHTTPHeaders</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="type">SessionManager</span>(configuration: configuration)</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>

<p>Manager类是以单利的形式对外使用的，创建SessionManager对象时指定了一个默认的<code>URLSessionConfiguration</code>和<code>defaultHTTPHeaders</code>。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(</span><br><span class="line">    configuration: <span class="type">URLSessionConfiguration</span> = <span class="type">URLSessionConfiguration</span>.<span class="keyword">default</span>,</span><br><span class="line">    delegate: <span class="type">SessionDelegate</span> = <span class="type">SessionDelegate</span>(),</span><br><span class="line">    serverTrustPolicyManager: <span class="type">ServerTrustPolicyManager?</span> = <span class="literal">nil</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.delegate = delegate</span><br><span class="line">    <span class="keyword">self</span>.session = <span class="type">URLSession</span>(configuration: configuration, delegate: delegate, delegateQueue: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">    commonInit(serverTrustPolicyManager: serverTrustPolicyManager)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">commonInit</span><span class="params">(serverTrustPolicyManager: ServerTrustPolicyManager?)</span></span> &#123;</span><br><span class="line">    session.serverTrustPolicyManager = serverTrustPolicyManager</span><br><span class="line"></span><br><span class="line">    delegate.sessionManager = <span class="keyword">self</span></span><br><span class="line"></span><br><span class="line">    delegate.sessionDidFinishEventsForBackgroundURLSession = &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] session <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> strongSelf = <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        <span class="type">DispatchQueue</span>.main.async &#123; strongSelf.backgroundCompletionHandler?() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SessionManager的<code>init</code>方法中，初始化了SessionDelegate和URLSession，并并SessionDelegate对象作为URLSession的delegate。</p>
<h4 id="2-Manager的request方法"><a href="#2-Manager的request方法" class="headerlink" title="2.Manager的request方法"></a>2.Manager的request方法</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@discardableResult</span></span><br><span class="line"><span class="keyword">open</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="number">_</span> url: URLConvertible,</span></span></span><br><span class="line"><span class="function"><span class="params">    method: HTTPMethod = .<span class="keyword">get</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    parameters: Parameters? = <span class="literal">nil</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    encoding: ParameterEncoding = URLEncoding.<span class="keyword">default</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    headers: HTTPHeaders? = <span class="literal">nil</span>)</span></span></span><br><span class="line">    -&gt; <span class="type">DataRequest</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> originalRequest: <span class="type">URLRequest?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        originalRequest = <span class="keyword">try</span> <span class="type">URLRequest</span>(url: url, method: method, headers: headers)</span><br><span class="line">        <span class="comment">/// 对参数进行编码, 其中encoding方法会根据ParameterEncoding的类型不同返回不同的request</span></span><br><span class="line">        <span class="keyword">let</span> encodedURLRequest = <span class="keyword">try</span> encoding.encode(originalRequest!, with: parameters)</span><br><span class="line">        <span class="keyword">return</span> request(encodedURLRequest)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> request(originalRequest, failedWith: error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>url</code>是一个实现了<code>URLConvertible</code>的对象，<code>method</code>参数表示请求方式（GET、POST、PUT等），<code>parameters</code>就是请求参数，<code>encoding:ParameterEncoding</code>是请求参数的编码方式，在Alamofire的源码里面有URLEncoding、JSONEncoding、PropertyListEncoding，这里默认的是URL 编码。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@discardableResult</span></span><br><span class="line"><span class="keyword">open</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> urlRequest: URLRequestConvertible)</span></span> -&gt; <span class="type">DataRequest</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> originalRequest: <span class="type">URLRequest?</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        originalRequest = <span class="keyword">try</span> urlRequest.asURLRequest()</span><br><span class="line">        <span class="keyword">let</span> originalTask = <span class="type">DataRequest</span>.<span class="type">Requestable</span>(urlRequest: originalRequest!)<span class="comment">//return TaskConvertible</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> task = <span class="keyword">try</span> originalTask.task(session: session, adapter: adapter, queue: queue)</span><br><span class="line">        <span class="keyword">let</span> request = <span class="type">DataRequest</span>(session: session, requestTask: .data(originalTask, task))</span><br><span class="line">        delegate[task] = request</span><br><span class="line">        <span class="keyword">if</span> startRequestsImmediately &#123; request.resume() &#125;</span><br><span class="line">        <span class="keyword">return</span> request</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> request(originalRequest, failedWith: error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的<code>request</code>的方法主要是负责通过Session创建DataTask，并用task对象初始化DataRequest类的对象，并将request存入ManagerDelegate类的属性中<code>delegate[task] = request</code>，因为在delegate属性中的代理方法是调用相应的TaskDelegate类的方法。</p>
<p>然后默认调用<code>request.resume</code>发起网络请求。</p>
<h3 id="SessionDelegate"><a href="#SessionDelegate" class="headerlink" title="SessionDelegate"></a>SessionDelegate</h3><p>这个类主要是URLSessionDelegate以及相关子协议的代理类，其中给出了各个代理方法的默认实现，并将URLSessionDelegate的相关代理封装成闭包的形式提供给外部。如果闭包变量不为空则会执行闭包块的内容，而不会执行默认的实现。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: URLSessionDelegate Overrides</span></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">var</span> sessionDidReceiveChallenge: ((<span class="type">URLSession</span>, <span class="type">URLAuthenticationChallenge</span>) -&gt; (<span class="type">URLSession</span>.<span class="type">AuthChallengeDisposition</span>, <span class="type">URLCredential?</span>))?</span><br><span class="line"><span class="keyword">open</span> <span class="keyword">var</span> sessionDidReceiveChallengeWithCompletion: ((<span class="type">URLSession</span>, <span class="type">URLAuthenticationChallenge</span>, @escaping (<span class="type">URLSession</span>.<span class="type">AuthChallengeDisposition</span>, <span class="type">URLCredential?</span>) -&gt; <span class="type">Void</span>) -&gt; <span class="type">Void</span>)?</span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: URLSessionDataDelegate Overrides</span></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">var</span> dataTaskDidReceiveResponse: ((<span class="type">URLSession</span>, <span class="type">URLSessionDataTask</span>, <span class="type">URLResponse</span>) -&gt; <span class="type">URLSession</span>.<span class="type">ResponseDisposition</span>)?</span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: URLSessionDownloadDelegate Overrides</span></span><br><span class="line"><span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> retrier: <span class="type">RequestRetrier?</span></span><br><span class="line"><span class="keyword">weak</span> <span class="keyword">var</span> sessionManager: <span class="type">SessionManager?</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> requests: [<span class="type">Int</span>: <span class="type">Request</span>] = [:]</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">let</span> lock = <span class="type">NSLock</span>()</span><br><span class="line"><span class="comment">/// Access the task delegate for the specified task in a thread-safe manner.</span></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">subscript</span>(task: <span class="type">URLSessionTask</span>) -&gt; <span class="type">Request?</span> &#123;</span><br><span class="line">    <span class="keyword">get</span> &#123;</span><br><span class="line">        lock.lock() ; <span class="keyword">defer</span> &#123; lock.unlock() &#125;</span><br><span class="line">        <span class="keyword">return</span> requests[task.taskIdentifier]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span> &#123;</span><br><span class="line">        lock.lock() ; <span class="keyword">defer</span> &#123; lock.unlock() &#125;</span><br><span class="line">        requests[task.taskIdentifier] = newValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">SessionDelegate</span>: <span class="title">URLSessionDelegate</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">SessionDelegate</span>: <span class="title">URLSessionTaskDelegate</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">SessionDelegate</span>: <span class="title">URLSessionDataDelegate</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">SessionDelegate</span>: <span class="title">URLSessionDownloadDelegate</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">SessionDelegate</span>: <span class="title">URLSessionStreamDelegate</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>subscript</code>表示自定义下标，可以通过<code>delegate[task]</code>的形式进行访问；</p>
</li>
<li><p>使用到NSLock来保证线程安全以便在访问指定的task时；</p>
</li>
<li><p><code>requests</code>负责储存request对象，以便SessionDelegate在URLSessionDelegate相应的代理方法中通过<code>self[task]?.delegate</code>，获取到TaskDelegate对象来调用其方法，例如以下的代理方法中的实现：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="number">_</span> session: URLSession,</span></span></span><br><span class="line"><span class="function"><span class="params">    task: URLSessionTask,</span></span></span><br><span class="line"><span class="function"><span class="params">    didReceive challenge: URLAuthenticationChallenge,</span></span></span><br><span class="line"><span class="function"><span class="params">    completionHandler: @escaping <span class="params">(URLSession.AuthChallengeDisposition, URLCredential?)</span></span></span> -&gt; <span class="type">Void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">guard</span> taskDidReceiveChallengeWithCompletion == <span class="literal">nil</span> <span class="keyword">else</span> &#123;</span><br><span class="line">        taskDidReceiveChallengeWithCompletion?(session, task, challenge, completionHandler)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> taskDidReceiveChallenge = taskDidReceiveChallenge &#123;</span><br><span class="line">        <span class="keyword">let</span> result = taskDidReceiveChallenge(session, task, challenge)</span><br><span class="line">        completionHandler(result.<span class="number">0</span>, result.<span class="number">1</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> delegate = <span class="keyword">self</span>[task]?.delegate &#123;</span><br><span class="line">        delegate.urlSession(</span><br><span class="line">            session,</span><br><span class="line">            task: task,</span><br><span class="line">            didReceive: challenge,</span><br><span class="line">            completionHandler: completionHandler</span><br><span class="line">        )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        urlSession(session, didReceive: challenge, completionHandler: completionHandler)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Request相关类"><a href="#Request相关类" class="headerlink" title="Request相关类"></a>Request相关类</h3><h4 id="1-Request初始化"><a href="#1-Request初始化" class="headerlink" title="1.Request初始化"></a>1.Request初始化</h4><p>Request就是负责通过会话创建各种类型的Task，并给出相应的Task Delegate。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">init</span>(session: <span class="type">URLSession</span>, requestTask: <span class="type">RequestTask</span>, error: <span class="type">Error?</span> = <span class="literal">nil</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.session = session</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> requestTask &#123;</span><br><span class="line">    <span class="keyword">case</span> .data(<span class="keyword">let</span> originalTask, <span class="keyword">let</span> task):</span><br><span class="line">        taskDelegate = <span class="type">DataTaskDelegate</span>(task: task)</span><br><span class="line">        <span class="keyword">self</span>.originalTask = originalTask</span><br><span class="line">    <span class="keyword">case</span> .download(<span class="keyword">let</span> originalTask, <span class="keyword">let</span> task):</span><br><span class="line">        taskDelegate = <span class="type">DownloadTaskDelegate</span>(task: task)</span><br><span class="line">        <span class="keyword">self</span>.originalTask = originalTask</span><br><span class="line">    <span class="keyword">case</span> .upload(<span class="keyword">let</span> originalTask, <span class="keyword">let</span> task):</span><br><span class="line">        taskDelegate = <span class="type">UploadTaskDelegate</span>(task: task)</span><br><span class="line">        <span class="keyword">self</span>.originalTask = originalTask</span><br><span class="line">    <span class="keyword">case</span> .stream(<span class="keyword">let</span> originalTask, <span class="keyword">let</span> task):</span><br><span class="line">        taskDelegate = <span class="type">TaskDelegate</span>(task: task)</span><br><span class="line">        <span class="keyword">self</span>.originalTask = originalTask</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    delegate.error = error</span><br><span class="line">    delegate.queue.addOperation &#123; <span class="keyword">self</span>.endTime = <span class="type">CFAbsoluteTimeGetCurrent</span>() &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始化方法需要两个参数：第一个参数是URLSession对象，改对象时SessionManager单例持有的session，第二个参数同样是Manager中传过来的<code>RequestTask</code>枚举类型，根据RequestTask的类型来设置代理对象DataDelegate，例如如果是data类型则创建的是DataDelegate的实例。</p>
<h4 id="Request的ProgressHandler闭包"><a href="#Request的ProgressHandler闭包" class="headerlink" title="Request的ProgressHandler闭包"></a>Request的ProgressHandler闭包</h4><p>在使用Request类的对象时，可以链式地调用Request中的方法，最常用的是获取相应任务执行的进度：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Alamofire</span>.request(<span class="type">URL</span>(string: <span class="string">"https://httpbin.org/get"</span>)!).downloadProgress &#123; (progress) <span class="keyword">in</span></span><br><span class="line">    <span class="comment">/// progress</span></span><br><span class="line">    </span><br><span class="line">&#125;.response &#123; (response) <span class="keyword">in</span></span><br><span class="line">    <span class="comment">/// response</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中DataRequest和DownloadRequest定义的是downloadProgress，UploadRequest定义的是uploadProgress闭包，可以通过这个闭包监听下载或上传的进度。</p>
<h4 id="resume方法"><a href="#resume方法" class="headerlink" title="resume方法"></a>resume方法</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="function"><span class="keyword">func</span> <span class="title">resume</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> task = task <span class="keyword">else</span> &#123; delegate.queue.isSuspended = <span class="literal">false</span> ; <span class="keyword">return</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> startTime == <span class="literal">nil</span> &#123; startTime = <span class="type">CFAbsoluteTimeGetCurrent</span>() &#125;</span><br><span class="line">    </span><br><span class="line">    task.resume()</span><br><span class="line">    </span><br><span class="line">    <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.post(</span><br><span class="line">        name: <span class="type">Notification</span>.<span class="type">Name</span>.<span class="type">Task</span>.<span class="type">DidResume</span>,</span><br><span class="line">        object: <span class="keyword">self</span>,</span><br><span class="line">        userInfo: [<span class="type">Notification</span>.<span class="type">Key</span>.<span class="type">Task</span>: task]</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>resume</code>方法主要是用来记录startTime，然后调用task的resume方法开始执行任务，并发出相应的通知。</p>
<h3 id="ResponseSerialization"><a href="#ResponseSerialization" class="headerlink" title="ResponseSerialization"></a>ResponseSerialization</h3><p> ResponseSerialization是用来对Response返回的值进行序列化。在文件中定义了两个protocol：<code>DataResponseSerializerProtocol</code>和<code>DownloadResponseSerializerProtocol</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">DataResponseSerializerProtocol</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// The type of serialized object to be created by this `DataResponseSerializerType`.</span></span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">SerializedObject</span></span><br><span class="line">    <span class="keyword">var</span> serializeResponse: (<span class="type">URLRequest?</span>, <span class="type">HTTPURLResponse?</span>, <span class="type">Data?</span>, <span class="type">Error?</span>) -&gt; <span class="type">Result</span>&lt;<span class="type">SerializedObject</span>&gt; &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">DownloadResponseSerializerProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">SerializedObject</span></span><br><span class="line">    <span class="keyword">var</span> serializeResponse: (<span class="type">URLRequest?</span>, <span class="type">HTTPURLResponse?</span>, <span class="type">URL?</span>, <span class="type">Error?</span>) -&gt; <span class="type">Result</span>&lt;<span class="type">SerializedObject</span>&gt; &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两个protocol分别由<code>DataResponseSerializer&lt;Value&gt;</code>和<code>DownloadResponseSerializer&lt;Value&gt;</code>来实现。</p>
<p>在Alamofire中调用DataRequest的的<code>response</code>或者<code>responseJSON</code>等其他方法，就会在request结束时，添加一个操作<code>OperationQueue</code>来处理服务器的response。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@discardableResult</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">response</span>&lt;T: DataResponseSerializerProtocol&gt;<span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    queue: DispatchQueue? = <span class="literal">nil</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    responseSerializer: T,</span></span></span><br><span class="line"><span class="function"><span class="params">    completionHandler: @escaping <span class="params">(DataResponse&lt;T.SerializedObject&gt;)</span></span></span> -&gt; <span class="type">Void</span>)</span><br><span class="line">    -&gt; <span class="type">Self</span></span><br><span class="line">&#123;</span><br><span class="line">    delegate.queue.addOperation &#123;</span><br><span class="line">        <span class="keyword">let</span> result = responseSerializer.serializeResponse(</span><br><span class="line">            <span class="keyword">self</span>.request,</span><br><span class="line">            <span class="keyword">self</span>.response,</span><br><span class="line">            <span class="keyword">self</span>.delegate.data,</span><br><span class="line">            <span class="keyword">self</span>.delegate.error</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> dataResponse = <span class="type">DataResponse</span>&lt;<span class="type">T</span>.<span class="type">SerializedObject</span>&gt;(</span><br><span class="line">            request: <span class="keyword">self</span>.request,</span><br><span class="line">            response: <span class="keyword">self</span>.response,</span><br><span class="line">            data: <span class="keyword">self</span>.delegate.data,</span><br><span class="line">            result: result,</span><br><span class="line">            timeline: <span class="keyword">self</span>.timeline</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        dataResponse.add(<span class="keyword">self</span>.delegate.metrics)</span><br><span class="line"></span><br><span class="line">        (queue ?? <span class="type">DispatchQueue</span>.main).async &#123; completionHandler(dataResponse) &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>总结：</p>
<p>在Alamofire框架中使用了协议、扩展、闭包以及枚举关联值，在解析网络数据的时，将闭包类型作为函数的参数，通过闭包变量来提供相应的解析方案。</p>
<ul>
<li><p>Alamofire对泛型的使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public enum Result&lt;Value&gt; &#123;&#125;</span><br><span class="line">public func validate&lt;S: Sequence&gt;(contentType acceptableContentTypes: S) -&gt; Self where S.Iterator.Element &#x3D;&#x3D; String &#123;&#125;</span><br><span class="line">public struct DataResponse&lt;Value&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>链式调用</p>
<p>对于Request类。其中很多方法都使用了返回<code>-&gt;Self</code>方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F; 鉴权</span><br><span class="line">open func authenticate(usingCredential credential: URLCredential) -&gt; Self &#123;&#125;</span><br><span class="line">&#x2F;&#x2F;&#x2F; 进度</span><br><span class="line">open func downloadProgress(queue: DispatchQueue &#x3D; DispatchQueue.main, closure: @escaping ProgressHandler) -&gt; Self &#123;&#125;</span><br><span class="line">&#x2F;&#x2F;&#x2F;响应</span><br><span class="line">public func response(queue: DispatchQueue? &#x3D; nil, completionHandler: @escaping (DefaultDataResponse) -&gt; Void) -&gt; Self &#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>顺序创建Task，并保存所有的requests。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">delegate[task] &#x3D; request</span><br><span class="line">open subscript(task: URLSessionTask) -&gt; Request? &#123;</span><br><span class="line">    get &#123;</span><br><span class="line">        lock.lock() ; defer &#123; lock.unlock() &#125;</span><br><span class="line">        return requests[task.taskIdentifier]</span><br><span class="line">    &#125;</span><br><span class="line">    set &#123;</span><br><span class="line">        lock.lock() ; defer &#123; lock.unlock() &#125;</span><br><span class="line">        requests[task.taskIdentifier] &#x3D; newValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在URLSession的回调中根据task把回调分发给对应的TaskDelegate</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/liututu1213/liututu1213.github.io/blog/blog/posts/2020/02/12/Cocoapods/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liututu1213">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="渣渣程序员">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/posts/2020/02/12/Cocoapods/" itemprop="url">Cocoapods源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-12T00:57:24+08:00">
                2020-02-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Ruby/" itemprop="url" rel="index">
                    <span itemprop="name">Ruby</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Cocoapods是开发OSX和iOS应用程序的一个第三方库的依赖管理工具，只用这个工具可以简化对组件依赖。更新过程。Cocoapods是用Ruby写的，由若干个gems组成：相关的<a href="https://github.com/CocoaPods">源码</a>。</p>
<ul>
<li><p><strong><a href="https://github.com/CocoaPods/Specs">CocoaPods/Specs</a></strong></p>
<p>这是保存第三方组件podspec文件的仓库，包含了每一个第三方组件所有版本的podsepc文件。</p>
</li>
<li><p><strong><a href="https://github.com/CocoaPods/CocoaPods">CocoaPods/CocoaPods</a></strong></p>
<p>一个面向用户的组件，每当执行<code>pod install</code>等命令时，都会调用这个组价。</p>
</li>
<li><p><strong><a href="https://github.com/CocoaPods/Core">CocoaPods/Core</a></strong></p>
<p>提供支持与Cocoapods相关文件的处理</p>
</li>
<li><p><strong><a href="https://github.com/CocoaPods/Xcodeproj">CocoaPods/Xcodeproj</a></strong></p>
<p>这个gem组件是用来创建和修改Xcode projects，负责所有工程文件的整合。</p>
</li>
<li><p><a href="https://www.rubydoc.info/gems/cocoapods-downloader" target="_blank" rel="noopener">CocoaPods Downloader</a>: 下载器</p>
</li>
<li><p><a href="https://www.rubydoc.info/gems/claide" target="_blank" rel="noopener">CLAide</a>: 命令行参数解析器</p>
</li>
<li><p><a href="https://github.com/CocoaPods/Molinillo">Molinillo</a> 依赖分析</p>
</li>
</ul>
<p>在Cocoapods中，所有的命令都会由<code>Commad</code>派发到对应的类。</p>
<h3 id="Debug-Cocoapods"><a href="#Debug-Cocoapods" class="headerlink" title="Debug Cocoapods"></a>Debug Cocoapods</h3><p>把Cocoapods相关的代码clone下来，Cocoapods项目作为入口，修改Cocoapods/Gemfile，指定每个依赖的path:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 声明Cocoapods对于git 仓库的依赖关系</span></span><br><span class="line"><span class="comment"># 兼容本地git 仓库模式开发</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cp_gem</span><span class="params">(name, repo_name, branch = <span class="string">'master'</span>, <span class="symbol">path:</span> <span class="literal">false</span>)</span></span></span><br><span class="line">  <span class="keyword">return</span> gem name <span class="keyword">if</span> SKIP_UNRELEASED_VERSIONS</span><br><span class="line">  <span class="comment"># 如果path参数为true，则将在".../[repo_name]"这个路径下搜索仓库</span></span><br><span class="line">  opts = <span class="keyword">if</span> path</span><br><span class="line">           &#123; <span class="symbol">:path</span> =&gt; <span class="string">"../<span class="subst">#&#123;repo_name&#125;</span>"</span> &#125;</span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">           url = <span class="string">"https://github.com/CocoaPods/<span class="subst">#&#123;repo_name&#125;</span>.git"</span></span><br><span class="line">           &#123; <span class="symbol">:git</span> =&gt; url, <span class="symbol">:branch</span> =&gt; branch &#125;</span><br><span class="line">         <span class="keyword">end</span></span><br><span class="line">  <span class="comment"># 返回标准的Gemfile Gem 导入格式</span></span><br><span class="line">  gem name, opts</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">source <span class="string">'https://rubygems.org'</span></span><br><span class="line"></span><br><span class="line">gemspec</span><br><span class="line"></span><br><span class="line">gem <span class="string">'json'</span>, <span class="symbol">:git</span> =&gt; <span class="string">'https://github.com/segiddins/json.git'</span>, <span class="symbol">:branch</span> =&gt; <span class="string">'seg-1.7.7-ruby-2.2'</span></span><br><span class="line"></span><br><span class="line">group <span class="symbol">:development</span> <span class="keyword">do</span></span><br><span class="line">  cp_gem <span class="string">'claide'</span>,                <span class="string">'CLAide'</span>, <span class="symbol">path:</span> <span class="string">'CLAide'</span></span><br><span class="line">  cp_gem <span class="string">'cocoapods-core'</span>,        <span class="string">'Core'</span>, <span class="symbol">path:</span> <span class="string">'Core'</span></span><br><span class="line">  cp_gem <span class="string">'cocoapods-deintegrate'</span>, <span class="string">'cocoapods-deintegrate'</span></span><br><span class="line">  cp_gem <span class="string">'cocoapods-downloader'</span>,  <span class="string">'cocoapods-downloader'</span>, <span class="symbol">path:</span> <span class="string">'cocoapods-downloader'</span></span><br><span class="line">  cp_gem <span class="string">'cocoapods-plugins'</span>,     <span class="string">'cocoapods-plugins'</span></span><br><span class="line">  cp_gem <span class="string">'cocoapods-search'</span>,      <span class="string">'cocoapods-search'</span></span><br><span class="line">  cp_gem <span class="string">'cocoapods-stats'</span>,       <span class="string">'cocoapods-stats'</span></span><br><span class="line">  cp_gem <span class="string">'cocoapods-trunk'</span>,       <span class="string">'cocoapods-trunk'</span></span><br><span class="line">  cp_gem <span class="string">'cocoapods-try'</span>,         <span class="string">'cocoapods-try'</span></span><br><span class="line">  cp_gem <span class="string">'molinillo'</span>,             <span class="string">'Molinillo'</span>, <span class="symbol">path:</span> <span class="string">'Molinillo'</span></span><br><span class="line">  cp_gem <span class="string">'nanaimo'</span>,               <span class="string">'Nanaimo'</span></span><br><span class="line">  cp_gem <span class="string">'xcodeproj'</span>,             <span class="string">'Xcodeproj'</span>, <span class="symbol">path:</span> <span class="string">'Xcodeproj'</span></span><br><span class="line">  ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<ol>
<li>在Cocoapods目录下，执行<code>bundle install</code></li>
<li>进入CocoaPods/examples/AFNetworking\ Example，执行<code>bundle exec pod install</code></li>
</ol>
<h3 id="pod-install的分析"><a href="#pod-install的分析" class="headerlink" title="pod install的分析"></a>pod install的分析</h3><h4 id="pod-命令的入口"><a href="#pod-命令的入口" class="headerlink" title="pod  命令的入口"></a>pod  命令的入口</h4><p>当输入<code>pod install</code>命令的时候，首先系统会调用这个<code>pod</code>命令，所有的命令都是在<code>/bin</code>目录下存放的脚本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ command which pod</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;pod</span><br></pre></td></tr></table></figure>

<p>打开这个入口脚本<code>pod</code>文件：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/System/Library/Frameworks/Ruby.framework/Versions/2.6/usr/bin/ruby</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This file was generated by RubyGems.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The application 'cocoapods' is installed as part of a gem, and</span></span><br><span class="line"><span class="comment"># this file is here to facilitate running it.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'rubygems'</span></span><br><span class="line"></span><br><span class="line">version = <span class="string">"&gt;= 0.a"</span></span><br><span class="line"></span><br><span class="line">str = ARGV.first</span><br><span class="line"><span class="keyword">if</span> str</span><br><span class="line">  <span class="comment"># \A代表输入开始的位置，\z代表输入的结束</span></span><br><span class="line">  str = str.b[<span class="regexp">/\A_(.*)_\z/</span>, <span class="number">1</span>]</span><br><span class="line">  <span class="keyword">if</span> str <span class="keyword">and</span> Gem::Version.correct?(str)</span><br><span class="line">    version = str</span><br><span class="line">    <span class="comment"># shift 拿出第一个元素并移除</span></span><br><span class="line">    ARGV.shift</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> Gem.respond_to?(<span class="symbol">:activate_bin_path</span>)</span><br><span class="line">load Gem.activate_bin_path(<span class="string">'cocoapods'</span>, <span class="string">'pod'</span>, version)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">gem <span class="string">"cocoapods"</span>, version</span><br><span class="line">load Gem.bin_path(<span class="string">"cocoapods"</span>, <span class="string">"pod"</span>, version)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>入口中将命令的执行指向了Gem组件的Path中，这样就找到了Cocoapods的入口脚本，即在<code>cocoapods/bin</code>目录下的<code>pod</code>。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'cocoapods'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> profile_filename = ENV[<span class="string">'COCOAPODS_PROFILE'</span>]</span><br><span class="line">  <span class="keyword">require</span> <span class="string">'ruby-prof'</span></span><br><span class="line">  reporter =</span><br><span class="line">    <span class="keyword">case</span> (profile_extname = File.extname(profile_filename))</span><br><span class="line">    <span class="keyword">when</span> <span class="string">'.txt'</span></span><br><span class="line">      RubyProf::FlatPrinterWithLineNumbers</span><br><span class="line">    <span class="keyword">when</span> <span class="string">'.html'</span></span><br><span class="line">      RubyProf::GraphHtmlPrinter</span><br><span class="line">    <span class="keyword">when</span> <span class="string">'.callgrind'</span></span><br><span class="line">      RubyProf::CallTreePrinter</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      raise <span class="string">"Unknown profiler format indicated by extension: <span class="subst">#&#123;profile_extname&#125;</span>"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  File.open(profile_filename, <span class="string">'w'</span>) <span class="keyword">do</span> <span class="params">|io|</span></span><br><span class="line">    reporter.new(RubyProf.profile &#123; Pod::Command.run(ARGV) &#125;).print(io)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  Pod::Command.run(ARGV)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>在最后部分，通过调用<code>Pod::Command.run(ARGV)</code>,实例化了一个<code>CLAide::Command</code>对象，用户输入的命令及参数进入CLAide解析阶段，这个是一个命令解析工具，每次命令的执行，其实是对应到具体class的<code>run</code>方法。  </p>
<p>执行<code>pod install</code>的类是<code>Install</code>，继承于<code>Command</code>， 根据Podfile.lock的版本安装项目依赖项：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Pod</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Command</span></span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Install</span> &lt; Command</span></span><br><span class="line">      <span class="keyword">include</span> RepoUpdate</span><br><span class="line">      <span class="keyword">include</span> ProjectDirectory</span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">options</span></span></span><br><span class="line">        [</span><br><span class="line">          [<span class="string">'--repo-update'</span>, <span class="string">'Force running `pod repo update` before install'</span>],</span><br><span class="line">          [<span class="string">'--deployment'</span>, <span class="string">'Disallow any changes to the Podfile or the Podfile.lock during installation'</span>],</span><br><span class="line">          [<span class="string">'--clean-install'</span>, <span class="string">'Ignore the contents of the project cache and force a full pod installation. This only '</span> \</span><br><span class="line">            <span class="string">'applies to projects that have enabled incremental installation'</span>],</span><br><span class="line">        ].concat(<span class="keyword">super</span>).reject &#123; <span class="params">|(name, _)|</span> name == <span class="string">'--no-repo-update'</span> &#125;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(argv)</span></span></span><br><span class="line">        <span class="keyword">super</span></span><br><span class="line">        @deployment = argv.flag?(<span class="string">'deployment'</span>, <span class="literal">false</span>)</span><br><span class="line">        @clean_install = argv.flag?(<span class="string">'clean-install'</span>, <span class="literal">false</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">run</span></span></span><br><span class="line">        verify_podfile_exists!</span><br><span class="line">        installer = installer_for_config</span><br><span class="line">        installer.repo_update = repo_update?(<span class="symbol">:default</span> =&gt; <span class="literal">false</span>)</span><br><span class="line">        installer.update = <span class="literal">false</span></span><br><span class="line">        installer.deployment = @deployment</span><br><span class="line">        installer.clean_install = @clean_install</span><br><span class="line">        installer.install!</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>Install</code>是继承于<code>Command</code>命令的，所以对应的命令为<code>pod install</code>。如下写了一个<code>Test</code>类继承于<code>Command</code>类，实现<code>run</code>方法。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Pod</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Command</span></span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> &lt; Command</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">run</span></span></span><br><span class="line">        puts <span class="string">"----Test running--"</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>在命令行输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ bundle exec pod test</span><br><span class="line">----Test running--</span><br></pre></td></tr></table></figure>



<h4 id="pod-install主流程分析"><a href="#pod-install主流程分析" class="headerlink" title="pod install主流程分析"></a>pod install主流程分析</h4><p><code>installer.rb</code>中的<code>run</code>方法中会从config中取一个<code>installer</code>的实例，再执行<code>install</code>方法，<code>installer</code>还有一个<code>update</code>的属性，这个就是<code>pod install</code>和<code>pod update</code>最大的区别：<code>pod update</code>会忽略Podfile.lock文件，重新对依赖进行分析。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Pod</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Command</span></span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Update</span> &lt; Command</span></span><br><span class="line">      <span class="keyword">include</span> RepoUpdate</span><br><span class="line">      <span class="keyword">include</span> ProjectDirectory</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">run</span></span></span><br><span class="line">        verify_podfile_exists!</span><br><span class="line"></span><br><span class="line">        installer = installer_for_config</span><br><span class="line">        installer.repo_update = repo_update?(<span class="symbol">:default</span> =&gt; <span class="literal">true</span>)</span><br><span class="line">        installer.clean_install = @clean_install</span><br><span class="line">        <span class="keyword">if</span> @pods.any? <span class="params">||</span> @excluded_pods.any? <span class="params">||</span> @source_pods.any?</span><br><span class="line">          verify_lockfile_exists!</span><br><span class="line">          verify_pods_are_installed!</span><br><span class="line">          verify_excluded_pods_are_installed!</span><br><span class="line"></span><br><span class="line">          @pods += @source_pods.select &#123; <span class="params">|pod|</span> config.lockfile.pod_names.<span class="keyword">include</span>?(pod) &#125;</span><br><span class="line">          @pods = config.lockfile.pod_names.dup <span class="keyword">if</span> @pods.empty?</span><br><span class="line">          @pods -= @excluded_pods</span><br><span class="line"></span><br><span class="line">          installer.update = &#123; <span class="symbol">:pods</span> =&gt; @pods &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          UI.puts <span class="string">'Update all pods'</span>.yellow</span><br><span class="line">          installer.update = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        installer.install!</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="1-installer-for-config"><a href="#1-installer-for-config" class="headerlink" title="1.  installer_for_config"></a>1.  installer_for_config</h5><p>Podfile的解析是由<a href="https://github.com/CocoaPods/Core">Core</a>这个模块来完成的。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">installer_for_config</span></span></span><br><span class="line">  Installer.new(config.sandbox, config.podfile, config.lockfile)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>installer_for_config</code>方法获取config中的podfile、lockfile等信息实例一个<code>installer</code>。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">podfile</span></span></span><br><span class="line">  @podfile <span class="params">||</span>= Podfile.from_file(podfile_path) <span class="keyword">if</span> podfile_path</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">from_file</span><span class="params">(path)</span></span></span><br><span class="line">  path = Pathname.new(path)</span><br><span class="line">  <span class="keyword">unless</span> path.exist?</span><br><span class="line">    raise Informative, <span class="string">"No Podfile exists at path `<span class="subst">#&#123;path&#125;</span>`."</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> path.extname</span><br><span class="line">  <span class="keyword">when</span> <span class="string">''</span>, <span class="string">'.podfile'</span>, <span class="string">'.rb'</span></span><br><span class="line">    Podfile.from_ruby(path)</span><br><span class="line">  <span class="keyword">when</span> <span class="string">'.yaml'</span></span><br><span class="line">    Podfile.from_yaml(path)</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    raise Informative, <span class="string">"Unsupported Podfile format `<span class="subst">#&#123;path&#125;</span>`."</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>在Cocoapods/lib/cocoapods/config.rb中取出一个<code>Podfile</code>类的实例。<code>from_file</code>这个方法会根据Podfile类型的不同而选择不同的调用路径。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">from_ruby</span><span class="params">(path, contents = <span class="literal">nil</span>)</span></span></span><br><span class="line">  contents <span class="params">||</span>= File.open(path, <span class="string">'r:utf-8'</span>, &amp;<span class="symbol">:read</span>) </span><br><span class="line">  podfile = Podfile.new(path) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      eval(contents, <span class="literal">nil</span>, path.to_s)</span><br><span class="line">    <span class="keyword">rescue</span> Exception =&gt; e</span><br><span class="line">      message = <span class="string">"Invalid `<span class="subst">#&#123;path.basename&#125;</span>` file: <span class="subst">#&#123;e.message&#125;</span>"</span></span><br><span class="line">      raise DSLError.new(message, path, e, contents)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  podfile</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>a ||= b</code>是一个条件赋值运算符，当a是未被定义或者为<code>false</code>，则计算b的值并将结果赋值给a，如果a是并定义且值为<code>true</code>，那么b则不会被计算。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Pod</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Podfile</span></span></span><br><span class="line">    <span class="class"><span class="keyword">module</span> <span class="title">DSL</span></span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">install!</span><span class="params">(installation_method, options = &#123;&#125;)</span></span> <span class="keyword">end</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">pod</span><span class="params">(name = <span class="literal">nil</span>, *requirements)</span></span> <span class="keyword">end</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">podspec</span><span class="params">(options = <span class="literal">nil</span>)</span></span> <span class="keyword">end</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">target</span><span class="params">(name, options = <span class="literal">nil</span>)</span></span> <span class="keyword">end</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">script_phase</span><span class="params">(options)</span></span> <span class="keyword">end</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">platform</span><span class="params">(name, target = <span class="literal">nil</span>)</span></span> <span class="keyword">end</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">project</span><span class="params">(path, build_configurations = &#123;&#125;)</span></span> <span class="keyword">end</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">link_with</span><span class="params">(*)</span></span> <span class="keyword">end</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">use_modular_headers!</span> <span class="title">end</span></span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">use_frameworks!</span><span class="params">(option = <span class="literal">true</span>)</span></span> <span class="keyword">end</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">(source)</span></span> <span class="keyword">end</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">pre_install</span><span class="params">(&amp;block)</span></span> <span class="keyword">end</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">post_install</span><span class="params">(&amp;block)</span></span> <span class="keyword">end</span></span><br><span class="line">      ...</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>在Podfile这个类的顶部，导入<code>include Pod::Podfile::DSL</code> 这行代码，这个<code>DSL</code>模块中定义了Podfile中所有方法。当使用<code>eval</code>执行文件中的代码时，就会执行这个模块里的方法。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">target</span><span class="params">(name, options = <span class="literal">nil</span>)</span></span></span><br><span class="line">  <span class="keyword">if</span> options</span><br><span class="line">    raise Informative, <span class="string">"Unsupported options `<span class="subst">#&#123;options&#125;</span>` for "</span> \</span><br><span class="line">    <span class="string">"target `<span class="subst">#&#123;name&#125;</span>`."</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  parent = current_target_definition</span><br><span class="line">  definition = TargetDefinition.new(name, parent)</span><br><span class="line">  <span class="keyword">self</span>.current_target_definition = definition</span><br><span class="line">  <span class="keyword">yield</span> <span class="keyword">if</span> block_given?</span><br><span class="line"><span class="keyword">ensure</span></span><br><span class="line">  <span class="keyword">self</span>.current_target_definition = parent</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这个方法会创建一个<code>TargetDefinition</code>类的实例，然后将它赋值给当前环境<code>current_target_definition</code>，这样之后使用<code>pod</code>定义的依赖都会填充在当前的<code>TargetDefinition</code>。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pod</span><span class="params">(name = <span class="literal">nil</span>, *requirements)</span></span></span><br><span class="line">	<span class="keyword">unless</span> name</span><br><span class="line">		raise StandardError, <span class="string">'A dependency requires a name.'</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	current_target_definition.store_pod(name, *requirements)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>pod 主要是指定target依赖项的名称和版本等，如以下方式：</p>
<ul>
<li>指定版本号，其中<code>~&gt; 0.1.2</code>表示版本等于<code>&#39;&gt;= 0.1.2&#39; &amp;&amp; &#39;&lt; 0.2.0&#39;</code>，且在符合要求的情况下总是匹配最新的版本。</li>
<li><code>pod &#39;xx&#39;, :configuration =&gt; &#39;Debug&#39;</code></li>
<li><code>pod &#39;xx&#39;, :subspecs =&gt; [&#39;xx&#39;, &#39;xx&#39;]</code></li>
<li><code>pod &#39;xx&#39;, :path =&gt; &#39;~/xx&#39;</code></li>
<li><code>pod &#39;xx&#39;, :git =&gt; &#39;xx&#39;, :branch =&gt; &#39;dev&#39;</code> 或者<code>:tag =&gt; &#39;&#39;</code>、<code>:commit =&gt; &#39;&#39;</code></li>
</ul>
<p>当<code>pod</code>方法被调用时，会执行target_definition.rb中的<code>store_pod</code>方法，将依赖储存到当前的<code>target</code>的<code>dependencies</code>数组中：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">store_pod</span><span class="params">(name, *requirements)</span></span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">if</span> parse_subspecs(name, requirements) <span class="comment"># This parse method must be called first</span></span><br><span class="line">  parse_inhibit_warnings(name, requirements)</span><br><span class="line">  parse_modular_headers(name, requirements)</span><br><span class="line">  parse_configuration_whitelist(name, requirements)</span><br><span class="line">  parse_project_name(name, requirements)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> requirements &amp;&amp; !requirements.empty?</span><br><span class="line">    pod = &#123; name =&gt; requirements &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    pod = name</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  get_hash_value(<span class="string">'dependencies'</span>, []) &lt;&lt; pod</span><br><span class="line">  <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>总结：Cocoapods对Podfile的解析简单概括就是构建了一个包含一些方法的上下文<code>DSL</code>，然后直接执行<code>eval</code>方法将文件的内容当做代码来执行，并将相应解析出来的数据储存到具体的类中。</p>
<p>在<code>installer</code>实例组装完成后，调用其<code>installer.install!</code>方法，进入<code>pod install</code>命令执行的主体部分。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">install!</span></span></span><br><span class="line">  <span class="comment"># 检测是否在Pods内部，如果不是则做一些install前准备工作</span></span><br><span class="line">  prepare</span><br><span class="line">  <span class="comment"># 依赖图的解析</span></span><br><span class="line">  resolve_dependencies</span><br><span class="line">  <span class="comment"># 依赖下载</span></span><br><span class="line">  download_dependencies</span><br><span class="line">  <span class="comment"># 检验之前流程中的产物Pod所生成的Targets的合法性</span></span><br><span class="line">  validate_targets</span><br><span class="line">  <span class="keyword">if</span> installation_options.skip_pods_project_generation?</span><br><span class="line">    show_skip_pods_project_generation_message</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    integrate</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  write_lockfiles</span><br><span class="line">  <span class="comment"># 执行任何install 后的操作， 例如一些plugin 可以插入在这里</span></span><br><span class="line">  perform_post_install_actions</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h5 id="2-prepare"><a href="#2-prepare" class="headerlink" title="2. prepare"></a>2. prepare</h5><p><code>prepare</code>方法的实现如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepare</span></span></span><br><span class="line">  <span class="comment"># Raise if pwd is inside Pods</span></span><br><span class="line">  <span class="comment"># 检测当前目录是项目根目录，直接抛出错误</span></span><br><span class="line">  <span class="keyword">if</span> Dir.pwd.start_with?(sandbox.root.to_path)</span><br><span class="line">    message = <span class="string">'Command should be run from a directory outside Pods directory.'</span></span><br><span class="line">    message &lt;&lt; <span class="string">"\n\n\tCurrent directory is <span class="subst">#&#123;UI.path(Pathname.pwd)&#125;</span>\n"</span></span><br><span class="line">    raise Informative, message</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  UI.message <span class="string">'Preparing'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 如果lock文件的Cocoapods版本和当前的版本不同，需要使用新版本依赖的xcodeproj对工程文件进行更新</span></span><br><span class="line">    deintegrate_if_different_major_version</span><br><span class="line">    <span class="comment"># 对sandbox（Pods）目录建立子目录结构</span></span><br><span class="line">    sandbox.prepare</span><br><span class="line">    <span class="comment"># 检测PluginManager 是否有pre-install的plugin</span></span><br><span class="line">    ensure_plugins_are_installed!</span><br><span class="line">    <span class="comment"># 执行插件中的pre-install的所有hooks方法</span></span><br><span class="line">    run_plugins_pre_install_hooks</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>在<code>prepare</code>阶段会将<code>pod install</code>的准备工作完成，包括版本一致性、Pods目录结构创建以及<code>pre-install</code>相关的plugins 脚本执行。</p>
<h5 id="3-依赖分析"><a href="#3-依赖分析" class="headerlink" title="3. 依赖分析"></a>3. 依赖分析</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resolve_dependencies</span></span></span><br><span class="line">  plugin_sources = run_source_provider_hooks</span><br><span class="line">  <span class="comment"># Analyzer 是通过分析Podfile、Podfile.lock，沙盒中的manifest，从而生成了一张依赖关系表</span></span><br><span class="line">  analyzer = create_analyzer(plugin_sources)</span><br><span class="line"></span><br><span class="line">  UI.section <span class="string">'Updating local specs repositories'</span> <span class="keyword">do</span></span><br><span class="line">    analyzer.update_repositories</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">if</span> repo_update? <span class="comment">#pod install --repo-update</span></span><br><span class="line"></span><br><span class="line">  UI.section <span class="string">'Analyzing dependencies'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 从analyzer取出最新的分析结果</span></span><br><span class="line">    analyze(analyzer)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 调试使用~</span></span><br><span class="line">    @analysis_result.podfile_dependency_cache.podfile_dependencies.each &#123; <span class="params">|item|</span> </span><br><span class="line">      p item</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p <span class="string">"------analysis_result-------"</span></span><br><span class="line">    p @analysis_result.podfile_state</span><br><span class="line">    p @analysis_result.sandbox_state</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Sepicat工程中各个target对应的spec情况</span></span><br><span class="line">    @analysis_result.specs_by_target.keys.each <span class="keyword">do</span> <span class="params">|item|</span></span><br><span class="line">      puts <span class="string">"----<span class="subst">#&#123;item&#125;</span>----"</span></span><br><span class="line">      @analysis_result.specs_by_target[item].each <span class="keyword">do</span> <span class="params">|sub_item|</span> <span class="comment">#specs_by_target查看各个target相关的specs</span></span><br><span class="line">        p sub_item</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 校验pod白名单的configuration的有效性 如拼写错误降级识别，白名单过滤</span></span><br><span class="line">    validate_build_configurations</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># pod install --deployment</span></span><br><span class="line">  <span class="comment"># 禁止在install 过程中变更 Podfile/Podfile.lock</span></span><br><span class="line">  UI.section <span class="string">'Verifying no changes'</span> <span class="keyword">do</span></span><br><span class="line">    verify_no_podfile_changes!</span><br><span class="line">    verify_no_lockfile_changes!</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">if</span> deployment?</span><br><span class="line"></span><br><span class="line">  analyzer</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>依赖解析过程会通过<code>Podfile</code>、<code>Podfild.lock</code>、<code>manifest</code>文件来生成一个<code>Analyzer</code>对象，在<code>Analyzer</code>内部会使用<strong>Molinillo</strong>。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">analyze</span><span class="params">(analyzer = create_analyzer)</span></span></span><br><span class="line">  @analysis_result = analyzer.analyze</span><br><span class="line">  @aggregate_targets = @analysis_result.targets</span><br><span class="line">  @pod_targets = @analysis_result.pod_targets</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>analyzer.analyze</code>会调用<code>resolve_dependencies</code>方法，最终会调用<code>Resolver</code>的<code>resolve</code>方法：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resolve</span></span></span><br><span class="line">  dependencies = @podfile_dependency_cache.target_definition_list.flat_map <span class="keyword">do</span> <span class="params">|target|</span></span><br><span class="line">    @podfile_dependency_cache.target_definition_dependencies(target).each <span class="keyword">do</span> <span class="params">|dep|</span></span><br><span class="line">      <span class="keyword">next</span> <span class="keyword">unless</span> target.platform</span><br><span class="line">      @platforms_by_dependency[dep].push(target.platform)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span>.uniq</span><br><span class="line">  @platforms_by_dependency.each_value(&amp;<span class="symbol">:uniq!</span>)</span><br><span class="line">  @activated = Molinillo::Resolver.new(<span class="keyword">self</span>, <span class="keyword">self</span>).resolve(dependencies, locked_dependencies)</span><br><span class="line">  resolver_specs_by_target</span><br><span class="line"><span class="keyword">rescue</span> Molinillo::ResolverError =&gt; e</span><br><span class="line">  handle_resolver_error(e)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这里的<code>Molinillo::Resolver</code>就是用于解决依赖关系的类。 <code>Milinillo</code>算法的核心是回溯(Backtracking)、向前检查(forward check)，整个过程会追踪栈中的两个状态（依赖和可能性）。</p>
<p>Resolver的大概过程如下：</p>
<p><img src="https://raw.githubusercontent.com/liututu1213/imageForSource/master/CocoaPods/Resolver.png" alt=""></p>
<p>下面是调试输出的日志：</p>
<p><code>podfile_dependency_cache.podfile_dependencies</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;Pod::Dependency name&#x3D;AFNetworking requirements&#x3D;&#x3D; 1.3.3 source&#x3D;nil external_source&#x3D;nil&gt;</span><br><span class="line">&lt;Pod::Dependency name&#x3D;SDWebImage requirements&#x3D;&gt;&#x3D; 0 source&#x3D;nil external_source&#x3D;nil&gt;</span><br><span class="line">&lt;Pod::Dependency name&#x3D;Moya requirements&#x3D;&gt;&#x3D; 0 source&#x3D;nil external_source&#x3D;nil&gt;</span><br><span class="line">&lt;Pod::Dependency name&#x3D;SnapKit requirements&#x3D;&gt;&#x3D; 0 source&#x3D;nil external_source&#x3D;nil&gt;</span><br></pre></td></tr></table></figure>

<p><code>@analysis_result.podfile_state</code>和 <code>@analysis_result.sandbox_state</code>分别的输出是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#&lt;Pod::Installer::Analyzer::SpecsState:0x00007ff58bbb5fc0 @added&#x3D;#&lt;Set: &#123;&#125;&gt;, @deleted&#x3D;#&lt;Set: &#123;&#125;&gt;, @changed&#x3D;#&lt;Set: &#123;&#125;&gt;, @unchanged&#x3D;#&lt;Set: &#123;&quot;AFNetworking&quot;, &quot;Moya&quot;, &quot;SDWebImage&quot;, &quot;SnapKit&quot;&#125;&gt;&gt;</span><br><span class="line">#&lt;Pod::Installer::Analyzer::SpecsState:0x00007ff58bbec980 @added&#x3D;#&lt;Set: &#123;&#125;&gt;, @deleted&#x3D;#&lt;Set: &#123;&#125;&gt;, @changed&#x3D;#&lt;Set: &#123;&#125;&gt;, @unchanged&#x3D;#&lt;Set: &#123;&quot;AFNetworking&quot;, &quot;Alamofire&quot;, &quot;Moya&quot;, &quot;Result&quot;, &quot;SDWebImage&quot;, &quot;SnapKit&quot;&#125;&gt;&gt;</span><br></pre></td></tr></table></figure>

<p><code>analysis_result.specs_by_target</code>查看各个target相关的specs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">----Pods-AFNetworking Example----</span><br><span class="line">#&lt;Pod::Specification name&#x3D;&quot;AFNetworking&quot;&gt;</span><br><span class="line">----Pods-AFNetworking iOS Example----</span><br><span class="line">#&lt;Pod::Specification name&#x3D;&quot;AFNetworking&quot;&gt;</span><br><span class="line">#&lt;Pod::Specification name&#x3D;&quot;Alamofire&quot;&gt;</span><br><span class="line">#&lt;Pod::Specification name&#x3D;&quot;Moya&quot;&gt;</span><br><span class="line">#&lt;Pod::Specification name&#x3D;&quot;Moya&#x2F;Core&quot;&gt;</span><br><span class="line">#&lt;Pod::Specification name&#x3D;&quot;Result&quot;&gt;</span><br><span class="line">#&lt;Pod::Specification name&#x3D;&quot;SDWebImage&quot;&gt;</span><br><span class="line">#&lt;Pod::Specification name&#x3D;&quot;SDWebImage&#x2F;Core&quot;&gt;</span><br><span class="line">#&lt;Pod::Specification name&#x3D;&quot;SnapKit&quot;&gt;</span><br></pre></td></tr></table></figure>



<h5 id="4-依赖下载"><a href="#4-依赖下载" class="headerlink" title="4. 依赖下载"></a>4. 依赖下载</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_dependencies</span></span></span><br><span class="line">  UI.section <span class="string">'Downloading dependencies'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 构造Pod Source Installer</span></span><br><span class="line">    install_pod_sources</span><br><span class="line">    <span class="comment"># 执行pre install 的hooks</span></span><br><span class="line">    run_podfile_pre_install_hooks</span><br><span class="line">    clean_pod_sources</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>下面是<code>install_pod_sources</code>方法的实现：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">install_pod_sources</span></span></span><br><span class="line">  @installed_specs = []</span><br><span class="line">  <span class="comment"># install的Pod只需要两种状态：added和changed状态的并集</span></span><br><span class="line">  pods_to_install = sandbox_state.added <span class="params">| sandbox_state.changed</span></span><br><span class="line"><span class="params">  title_options = &#123; :verbose_prefix =&gt; '-&gt; '.green &#125;</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">  # 将Podfile解析后排序处理</span></span><br><span class="line"><span class="params">  root_specs.sort_by(&amp;:name).each <span class="keyword">do</span> |</span>spec<span class="params">|</span></span><br><span class="line"><span class="params">    # 如果Pod是added或者changed状态</span></span><br><span class="line"><span class="params">    <span class="keyword">if</span> pods_to_install.<span class="keyword">include</span>?(spec.name)</span></span><br><span class="line"><span class="params">      # 如果是changed状态并且是manifest 已经有记录</span></span><br><span class="line"><span class="params">      <span class="keyword">if</span> sandbox_state.changed.<span class="keyword">include</span>?(spec.name) &amp;&amp; sandbox.manifest</span></span><br><span class="line"><span class="params">        # 版本更新</span></span><br><span class="line"><span class="params">        current_version = spec.version</span></span><br><span class="line"><span class="params">        # 被更新版本记录</span></span><br><span class="line"><span class="params">        previous_version = sandbox.manifest.version(spec.name)</span></span><br><span class="line"><span class="params">        # 变动记录</span></span><br><span class="line"><span class="params">        has_changed_version = current_version != previous_version</span></span><br><span class="line"><span class="params">        # 找到第一个包含spec.name的Pod，获取对应的Repo</span></span><br><span class="line"><span class="params">        current_repo = analysis_result.specs_by_source.detect &#123; |</span>key, values<span class="params">| <span class="keyword">break</span> key <span class="keyword">if</span> values.map(&amp;:name).<span class="keyword">include</span>?(spec.name) &#125;</span></span><br><span class="line"><span class="params">        # 获取当前的仓库</span></span><br><span class="line"><span class="params">        current_repo &amp;&amp;= current_repo.url |</span><span class="params">| current_repo.name</span></span><br><span class="line"><span class="params">        # 是否仓库有变动</span></span><br><span class="line"><span class="params">        previous_spec_repo = sandbox.manifest.spec_repo(spec.name)</span></span><br><span class="line"><span class="params">        has_changed_repo = !previous_spec_repo.<span class="literal">nil</span>? &amp;&amp; current_repo &amp;&amp; !current_repo.casecmp(previous_spec_repo).zero?</span></span><br><span class="line"><span class="params">        title = "Installing #&#123;spec.name&#125; #&#123;spec.version&#125;"</span></span><br><span class="line"><span class="params">        title &lt;&lt; " (was #&#123;previous_version&#125; <span class="keyword">and</span> source changed to `#&#123;current_repo&#125;` from `#&#123;previous_spec_repo&#125;`)" <span class="keyword">if</span> has_changed_version &amp;&amp; has_changed_repo</span></span><br><span class="line"><span class="params">        title &lt;&lt; " (was #&#123;previous_version&#125;)" <span class="keyword">if</span> has_changed_version &amp;&amp; !has_changed_repo</span></span><br><span class="line"><span class="params">        title &lt;&lt; " (source changed to `#&#123;current_repo&#125;` from `#&#123;previous_spec_repo&#125;`)" <span class="keyword">if</span> !has_changed_version &amp;&amp; has_changed_repo</span></span><br><span class="line"><span class="params">      <span class="keyword">else</span></span></span><br><span class="line"><span class="params">        # 非changed状态</span></span><br><span class="line"><span class="params">        title = "Installing #&#123;spec&#125;"</span></span><br><span class="line"><span class="params">      <span class="keyword">end</span></span></span><br><span class="line"><span class="params">      UI.titled_section(title.green, title_options) <span class="keyword">do</span></span></span><br><span class="line"><span class="params">        # 通过name拿到对应的installer，记录到@pod_installer中</span></span><br><span class="line"><span class="params">        install_source_of_pod(spec.name)</span></span><br><span class="line"><span class="params">      <span class="keyword">end</span></span></span><br><span class="line"><span class="params">    <span class="keyword">else</span></span></span><br><span class="line"><span class="params">      #如果没有changed情况,则创建一个PodSourceInstaller实例</span></span><br><span class="line"><span class="params">      UI.section("Using #&#123;spec&#125;".red, title_options[:verbose_prefix]) <span class="keyword">do</span></span></span><br><span class="line"><span class="params">        create_pod_installer(spec.name)</span></span><br><span class="line"><span class="params">      <span class="keyword">end</span></span></span><br><span class="line"><span class="params">    <span class="keyword">end</span></span></span><br><span class="line"><span class="params">  <span class="keyword">end</span></span></span><br><span class="line"><span class="params"><span class="keyword">end</span></span></span><br></pre></td></tr></table></figure>

<p>这个方法主要是根据依赖分析的结果，根据Pod的状态的不同进行不同的处理，如果在<code>pods_to_install</code>里面则安装Pod<code>install_source_of_pod</code>，否则直接走<code>create_pod_installer</code>方法，直接从缓存中取。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过缓存返回PodSourceInstaller实例</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_pod_installer</span><span class="params">(pod_name)</span></span></span><br><span class="line">  specs_by_platform = specs_for_pod(pod_name)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> specs_by_platform.empty?</span><br><span class="line">    requiring_targets = pod_targets.select &#123; <span class="params">|pt|</span> pt.recursive_dependent_targets.any? &#123; <span class="params">|dt|</span> dt.pod_name == pod_name &#125; &#125;</span><br><span class="line">    message = <span class="string">"Could not install '<span class="subst">#&#123;pod_name&#125;</span>' pod"</span></span><br><span class="line">    message += <span class="string">", dependended upon by <span class="subst">#&#123;requiring_targets.to_sentence&#125;</span>"</span> <span class="keyword">unless</span> requiring_targets.empty?</span><br><span class="line">    message += <span class="string">'. There is either no platform to build for, or no target to build.'</span></span><br><span class="line">    raise StandardError, message</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 通过sandbox，specs的platform信息生成Installer实例</span></span><br><span class="line">  pod_installer = PodSourceInstaller.new(sandbox, podfile, specs_by_platform, <span class="symbol">:can_cache</span> =&gt; installation_options.clean?)</span><br><span class="line">  pod_installers &lt;&lt; pod_installer</span><br><span class="line">  pod_installer</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Pods,如果resolver声明一个Pod已经安装或者已经存在则将其删除并重新安装</span></span><br><span class="line"><span class="comment"># 如果不存在则直接安装</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">install_source_of_pod</span><span class="params">(pod_name)</span></span></span><br><span class="line">  pod_installer = create_pod_installer(pod_name)</span><br><span class="line">  pod_installer.install!</span><br><span class="line">  @installed_specs.concat(pod_installer.specs_by_platform.values.flatten.uniq)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>pod_installer</code>会调用<code>install!</code>方法(pod_source_installer.rb)：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">install!</span></span></span><br><span class="line">  <span class="comment"># 如果未经历过pre-download阶段或者local阶段的Pod，则通过对应的Source下载</span></span><br><span class="line">  download_source <span class="keyword">unless</span> predownloaded? <span class="params">||</span> local?</span><br><span class="line">  <span class="comment"># 执行Spec 中的Prepar Command</span></span><br><span class="line">  PodSourcePreparer.new(root_spec, root).prepare! <span class="keyword">if</span> local?</span><br><span class="line">  sandbox.remove_local_podspec(name) <span class="keyword">unless</span> predownloaded? <span class="params">||</span> local? <span class="params">||</span> external?</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_source</span></span></span><br><span class="line">  verify_source_is_secure(root_spec)</span><br><span class="line">  download_result = Downloader.download(download_request, root, <span class="symbol">:can_cache</span> =&gt; can_cache?)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (specific_source = download_result.checkout_options) &amp;&amp; specific_source != root_spec.source</span><br><span class="line">    sandbox.store_checkout_source(root_spec.name, specific_source)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>上面的方法主要是将Pod通过对应的source下载下来，会去调用<code>Downloader</code>组件处理所有的下载的逻辑</p>
<h5 id="5-targets-校验"><a href="#5-targets-校验" class="headerlink" title="5. targets 校验"></a>5. targets 校验</h5><p><code>validate_targets</code>过程是用来验证之前流程中的产物Pod所生成的targets的合法性方法。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate_targets</span></span></span><br><span class="line">  validator = Xcode::TargetValidator.new(aggregate_targets, pod_targets, installation_options)</span><br><span class="line">  validator.validate!</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># target_validator.rb</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate!</span></span></span><br><span class="line">  <span class="comment"># 重名检测</span></span><br><span class="line">  verify_no_duplicate_framework_and_library_names</span><br><span class="line">  <span class="comment"># 用来验证动态库是否有静态库或者framework静态库</span></span><br><span class="line">  verify_no_static_framework_transitive_dependencies</span><br><span class="line">  <span class="comment"># 验证Pod中是否指明多个Swift版本，如果有的话需要检测这些依赖是否需要进行build</span></span><br><span class="line">  verify_swift_pods_swift_version</span><br><span class="line">  <span class="comment"># 验证Swift 的Pod是否有module依赖</span></span><br><span class="line">  verify_swift_pods_have_module_dependencies</span><br><span class="line">  verify_no_multiple_project_names <span class="keyword">if</span> installation_options.generate_multiple_pod_projects?</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>verify_no_static_framework_transitive_dependencies</code>这个方法是用来验证动态库中是否有.a或.framework的静态库，场景：A组件依赖B组件，B组件中通过<code>vendored_libraries</code>方式加载的静态库(.a、.framework)，如果此时在Podfile里面使用了<code>use_framework!</code>,在打包的时候<code>framework</code>会将<code>vendored_libraries</code>中的内容包括进来，这个时候就在符号决议的时候产生冲突，在混合开发的项目里面，动态库中依赖静态库的场景还是很常见的，可以查看这篇组件化的文章：<a href="https://www.valiantcat.cn/index.php/2017/04/24/45.html" target="_blank" rel="noopener">组件化-动态库实战</a>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The &#39;Pods-xx&#39; target has transitive dependencies that include static binaries: (static_libs.to_sentence)</span><br></pre></td></tr></table></figure>

<p>在swift项目中，必须使用<code>use_framework!</code>（目前Cocoapods1.5宣布已经支持Swift使用静态库），因此经常会遇到上述的问题。  </p>
<p>除了文章中这种处理方式，还可以通过修改cocoapods相关的参数达到目的：  </p>
<p>1.修改pod库中的<code>podspec</code>，增加<code>pod_target_xcconfig</code>(表示pod本身被依赖时，修改的编译选项，而user_target_xcconfig表示修改依赖pod的项目的编译选项)</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s.pod_target_xcconfig = &#123;</span><br><span class="line">    <span class="string">'FRAMEWORK_SEARCH_PATHS'</span> =&gt; <span class="string">'$(inherited) $(PODS_ROOT)/AlipaySDKIniOS'</span>,</span><br><span class="line">    <span class="string">'OTHER_LDFLAGS'</span>          =&gt; <span class="string">'$(inherited) -undefined dynamic_lookup'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>2.hook    <code>verify_no_static_framework_transitive_dependencies</code>方法，不对动态库依赖静态做检测</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pre_install <span class="keyword">do</span> <span class="params">|installer|</span></span><br><span class="line">    <span class="comment"># workaround for https://github.com/CocoaPods/CocoaPods/issues/3289</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">installer</span>.<span class="title">verify_no_static_framework_transitive_dependencies</span>;</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>特别说明下<code>vendored_libraries</code>是用来在<code>podspec</code>中指定依赖的静态库.a或.framework，如``s.vendored_libraries = ‘libWeiboSDK/libWeiboSDK.a’`。</p>
<h5 id="6-集成"><a href="#6-集成" class="headerlink" title="6. 集成"></a>6. 集成</h5><p> <code>generate_pods_project</code>会把所有的组件通过Project文件的形式组织起啦，并且对Project做一些用户指定的配置。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">integrate</span></span></span><br><span class="line">  <span class="comment"># 生成外层项目</span></span><br><span class="line">  generate_pods_project</span><br><span class="line">  <span class="keyword">if</span> installation_options.integrate_targets?</span><br><span class="line">    <span class="comment"># 集成用户配置，读取依赖项，使用xcconfig来配置</span></span><br><span class="line">    integrate_user_project</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    UI.section <span class="string">'Skipping User Project Integration'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_pods_project</span></span></span><br><span class="line">  stage_sandbox(sandbox, pod_targets)</span><br><span class="line"></span><br><span class="line">  cache_analysis_result = analyze_project_cache</span><br><span class="line">  pod_targets_to_generate = cache_analysis_result.pod_targets_to_generate</span><br><span class="line">  aggregate_targets_to_generate = cache_analysis_result.aggregate_targets_to_generate</span><br><span class="line"></span><br><span class="line">  clean_sandbox(pod_targets_to_generate)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># </span></span><br><span class="line">  create_and_save_projects(pod_targets_to_generate, aggregate_targets_to_generate,</span><br><span class="line">                           cache_analysis_result.build_configurations, cache_analysis_result.project_object_version)</span><br><span class="line">  SandboxDirCleaner.new(sandbox, pod_targets, aggregate_targets).clean!</span><br><span class="line"></span><br><span class="line">  update_project_cache(cache_analysis_result, target_installation_results)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">integrate_user_project</span></span></span><br><span class="line">  UI.section <span class="string">"Integrating client <span class="subst">#&#123;<span class="string">'project'</span>.pluralize(aggregate_targets.map(&amp;<span class="symbol">:user_project_path</span>).uniq.count)&#125;</span>"</span> <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">    installation_root = config.installation_root</span><br><span class="line">    integrator = UserProjectIntegrator.new(podfile, sandbox, installation_root, aggregate_targets, generated_aggregate_targets,</span><br><span class="line">                                           <span class="symbol">:use_input_output_paths</span> =&gt; !installation_options.disable_input_output_paths?)</span><br><span class="line">    integrator.integrate!</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>在<code>~/lib/cocoapods/installer/user_project_integrator.rb</code>文件中的<code>integrate</code>方法：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">integrate!</span></span></span><br><span class="line">  create_workspace</span><br><span class="line">  deintegrated_projects = deintegrate_removed_targets</span><br><span class="line">  integrate_user_targets</span><br><span class="line">  warn_about_xcconfig_overrides</span><br><span class="line">  projects_to_save = (user_projects_to_integrate + deintegrated_projects).uniq</span><br><span class="line">  save_projects(projects_to_save)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h3 id="pod-install-vs-pod-update"><a href="#pod-install-vs-pod-update" class="headerlink" title="pod install vs pod update"></a>pod install vs pod update</h3><p>在<a href="https://guides.cocoapods.org/using/pod-install-vs-update.html" target="_blank" rel="noopener">cocoapods guides</a> 中对于<code>pod install</code> vs <code>pod update</code>区别的翻译如下：</p>
<p>1.在项目中第一次使用Cocoapods时（即没有<code>Podfile.lock</code>文件的情况），或者在podfile中添加、删除、更新pods时，可使用<code>pod install</code>下载安装pod。</p>
<p>2.<code>pod update [PODNAME]</code>用在需要更新pods的最新版本时</p>
<h4 id="pod-install"><a href="#pod-install" class="headerlink" title="pod install"></a>pod install</h4><p>除了在新建工程时，需用到<code>pod install</code>，在后续执行<code>pod install</code>时，对于已经列在<code>podfile.lock</code>中的pod，它会下载lock锁定的版本，而不会去检查是否有最新的可用版本，对于没有在podfile.lock中文件的库，会根据podfile文件中指定的版本去下载符合指定返回内最新的版本。</p>
<h5 id="pod-update"><a href="#pod-update" class="headerlink" title="pod update"></a>pod update</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># update.rb</span></span><br><span class="line">installer.repo_update = repo_update?(<span class="symbol">:default</span> =&gt; <span class="literal">true</span>)</span><br><span class="line">installer.update = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># analyzer.rb</span></span><br><span class="line">deleted_and_changed += pods_to_update[<span class="symbol">:pods</span>] <span class="keyword">if</span> update_mode == <span class="symbol">:selected</span></span><br></pre></td></tr></table></figure>

<p><code>pod update [PODNAME]</code>命令，首先会更新本地的spec 仓库，<code>pod install</code>默认的<code>repo_update</code>为<code>false</code>。其次会忽略podfile.lock中的锁定的版本，更新到podfile中指定的版本。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/liututu1213/liututu1213.github.io/blog/blog/posts/2020/01/18/Ruby%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liututu1213">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="渣渣程序员">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/posts/2020/01/18/Ruby%E5%9F%BA%E7%A1%80/" itemprop="url">Ruby基础</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-18T00:56:10+08:00">
                2020-01-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Ruby/" itemprop="url" rel="index">
                    <span itemprop="name">Ruby</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-Ruby-面向对象概览"><a href="#1-Ruby-面向对象概览" class="headerlink" title="1. Ruby 面向对象概览"></a>1. Ruby 面向对象概览</h3><h4 id="1-1-基础变量"><a href="#1-1-基础变量" class="headerlink" title="1.1 基础变量"></a>1.1 基础变量</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">1</span></span><br><span class="line">y = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">puts x<span class="class">.<span class="keyword">class</span></span></span><br><span class="line">puts y<span class="class">.<span class="keyword">class</span></span></span><br></pre></td></tr></table></figure>

<p>打印结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Integer</span><br><span class="line">Float</span><br></pre></td></tr></table></figure>

<p>在Ruby中，变量可以包含Ruby可以理解的任何概念，==在Ruby中所有的元素，包括基本类型都是对象，这个内置类有定义好的方法来执行数字类的操作==，同时也不存在==运算符==的概念，所谓的<code>1 + 1</code>，其实只不过是<code>1. + (1)</code>的语法糖而已。</p>
<h4 id="1-2-Ruby-对象和类"><a href="#1-2-Ruby-对象和类" class="headerlink" title="1.2 Ruby 对象和类"></a>1.2 Ruby 对象和类</h4><h5 id="1-2-1-对象"><a href="#1-2-1-对象" class="headerlink" title="1.2.1 对象"></a>1.2.1 对象</h5><p>Ruby是一个面向对象的编程语言</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line">	<span class="keyword">attr_accessor</span> <span class="symbol">:name</span>, <span class="symbol">:age</span>, <span class="symbol">:gender</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">p = Person.new</span><br><span class="line">p.name = <span class="string">"小明"</span></span><br><span class="line">p.age = <span class="number">10</span></span><br><span class="line">p.gender = <span class="string">"woman"</span></span><br><span class="line"></span><br><span class="line">puts <span class="string">"<span class="subst">#&#123; p.name &#125;</span>"</span></span><br></pre></td></tr></table></figure>

<p><code>attr_accessor</code>创建了三个属性(attributes)，其中accessor表示让这些属性可访问，可被修改和设置，除此之外，还有attr_reader<code>表示只可读，</code>attr_writer`表示只可写入。</p>
<h5 id="1-2-2-继承"><a href="#1-2-2-继承" class="headerlink" title="1.2.2 继承"></a>1.2.2 继承</h5><p>面向对象编程的特点之一就是：继承。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pet</span></span></span><br><span class="line">	<span class="keyword">attr_accessor</span> <span class="symbol">:name</span>, <span class="symbol">:age</span>, <span class="symbol">:color</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> &lt;Pet</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> &lt;Pet</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">bark</span></span></span><br><span class="line">		puts <span class="string">"Woof !"</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Snake</span> &lt;Pet</span></span><br><span class="line">	<span class="keyword">attr_accessor</span> <span class="symbol">:length</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h4 id="1-2-3-Kernel模块的方法"><a href="#1-2-3-Kernel模块的方法" class="headerlink" title="1.2.3 Kernel模块的方法"></a>1.2.3 Kernel模块的方法</h4><p>Kernel是一个特殊的类，前面使用到的<code>puts</code>方法没有完整的类或者对象的前缀，实际上，<code>puts</code>是来自Kernel模块的方法，当调用<code>puts</code>时，Ruby发现没有指定任何类或对象，就在默认的、预定义的类和模块中查到相同名的方法，在Kernel模块中进行查找，并进行调用，也可以显式地调用<code>Kernel.puts &quot;hi&quot;</code>。</p>
<h3 id="2-Ruby的构造元素：数据、表达式和流程控制"><a href="#2-Ruby的构造元素：数据、表达式和流程控制" class="headerlink" title="2. Ruby的构造元素：数据、表达式和流程控制"></a>2. Ruby的构造元素：数据、表达式和流程控制</h3><h4 id="2-1-数字与表达式"><a href="#2-1-数字与表达式" class="headerlink" title="2.1 数字与表达式"></a>2.1 数字与表达式</h4><h5 id="2-1-1-比较运算符和表达式"><a href="#2-1-1-比较运算符和表达式" class="headerlink" title="2.1.1 比较运算符和表达式"></a>2.1.1 比较运算符和表达式</h5><table>
<thead>
<tr>
<th align="center">比较运算</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">x &gt;  y</td>
<td align="center">大于</td>
</tr>
<tr>
<td align="center">x &lt; y</td>
<td align="center">小于</td>
</tr>
<tr>
<td align="center">x == y</td>
<td align="center">等于</td>
</tr>
<tr>
<td align="center">x &gt;= y</td>
<td align="center">大于等于</td>
</tr>
<tr>
<td align="center">x &lt;= y</td>
<td align="center">小于等于</td>
</tr>
<tr>
<td align="center">x &lt;=&gt; y</td>
<td align="center">比较，如果x==y则返回0，x大于y则返回1，如果x小于y则返回-1</td>
</tr>
<tr>
<td align="center">x != y</td>
<td align="center">不等于</td>
</tr>
</tbody></table>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">10</span> </span><br><span class="line">y = <span class="number">3</span></span><br><span class="line">puts x.to_f / y.to_f</span><br><span class="line"></span><br><span class="line">z = <span class="number">3.845</span></span><br><span class="line">puts z.to_i</span><br><span class="line">puts z.round</span><br><span class="line"></span><br><span class="line">f = <span class="number">3.9</span></span><br><span class="line">puts f.floor</span><br><span class="line"></span><br><span class="line">c = <span class="number">10.1</span></span><br><span class="line">puts c.ceil</span><br></pre></td></tr></table></figure>

<p>打印结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">3.3333333333333335</span><br><span class="line">3</span><br><span class="line">3.85</span><br><span class="line">3</span><br><span class="line">11</span><br></pre></td></tr></table></figure>

<p>Ruby中提供函数用于浮点数（Float）和整数（Integer）之间的转换。<code>to_i</code>会直接去掉小数点，<code>round</code>为四舍五入，<code>floor</code>返回比接受者小的最大整数，<code>ceil</code>返回比接受者大的最大整数</p>
<h5 id="2-1-2-常量"><a href="#2-1-2-常量" class="headerlink" title="2.1.2 常量"></a>2.1.2 常量</h5><p>常量在Ruby中的表达形式是以大写字母开头的变量名。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Pi = <span class="number">3.141592</span></span><br><span class="line">Pi = <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">constant.rb:2: warning: already initialized constant Pi</span><br><span class="line">constant.rb:1: warning: previous definition of Pi was here</span><br></pre></td></tr></table></figure>

<p>对于常量的值，Ruby提供了完全的控制权，在前面定义的Dog等class 以大写字母开头的名字来引用类，是因为类一旦定义之后，就是程序的固化部分，与常量的性质类似。</p>
<h4 id="2-2-文本与字符串"><a href="#2-2-文本与字符串" class="headerlink" title="2.2 文本与字符串"></a>2.2 文本与字符串</h4><h5 id="2-2-1-字面字符串"><a href="#2-2-1-字面字符串" class="headerlink" title="2.2.1 字面字符串"></a>2.2.1 字面字符串</h5><p>在Ruby中所有的字符串都是String类的对象，<code>&quot;hello&quot;</code>这种构造的字符串称为字面字符串。</p>
<p>把字符串包含在程序中有许多方式，如用引号只适合于单行文本，如果是多行文本则可以使用如下的方式：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="string">%q&#123;this is string  </span></span><br><span class="line"><span class="string">of the multi line capabilities&#125;</span></span><br><span class="line">puts x</span><br></pre></td></tr></table></figure>

<p>在上面的例子中，引号被替换成<code>%q{}</code>,并且也可以用<code>&lt;&gt;</code>、<code>()</code>或其他自选的两个分解符代替引号。</p>
<h5 id="2-2-2-字符串表达式"><a href="#2-2-2-字符串表达式" class="headerlink" title="2.2.2 字符串表达式"></a>2.2.2 字符串表达式</h5><table>
<thead>
<tr>
<th align="center">表达式</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">“a” + “b”</td>
<td align="center">“ab”</td>
</tr>
<tr>
<td align="center">“abc” * 2</td>
<td align="center">“abcabc”</td>
</tr>
<tr>
<td align="center">puts “x” &gt; “y”      =&gt; false</td>
<td align="center">大小比较</td>
</tr>
</tbody></table>
<h5 id="2-2-3-字符串-占位符"><a href="#2-2-3-字符串-占位符" class="headerlink" title="2.2.3 字符串 占位符"></a>2.2.3 字符串 占位符</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">10</span></span><br><span class="line">y = <span class="number">20</span></span><br><span class="line">puts <span class="string">"<span class="subst">#&#123;x&#125;</span> + <span class="subst">#&#123;y&#125;</span> = <span class="subst">#&#123;x+y&#125;</span>"</span></span><br></pre></td></tr></table></figure>

<p>插写一段重复的字符串，可以使用以下方式：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">puts <span class="string">"it's a <span class="subst">#&#123;<span class="string">"bad "</span> * <span class="number">5</span>&#125;</span> world"</span></span><br></pre></td></tr></table></figure>



<h5 id="2-2-4-字符串方法"><a href="#2-2-4-字符串方法" class="headerlink" title="2.2.4 字符串方法"></a>2.2.4 字符串方法</h5><p>对字符串”Test”调用不同的方法的结果</p>
<table>
<thead>
<tr>
<th align="center">表达式</th>
<th align="center">结果</th>
</tr>
</thead>
<tbody><tr>
<td align="center">“Test”.capitalize</td>
<td align="center">Test</td>
</tr>
<tr>
<td align="center">puts “Test”.downcase</td>
<td align="center">Test</td>
</tr>
<tr>
<td align="center">“Test”.chop</td>
<td align="center">Tes</td>
</tr>
<tr>
<td align="center">“Test”.hash</td>
<td align="center">3285097822602877765</td>
</tr>
<tr>
<td align="center">“Test”.next</td>
<td align="center">Tesu</td>
</tr>
<tr>
<td align="center">“Test”.reverse</td>
<td align="center">tseT</td>
</tr>
<tr>
<td align="center">“Test”.sum</td>
<td align="center">416</td>
</tr>
<tr>
<td align="center">“Test”.swapcase</td>
<td align="center">tEST</td>
</tr>
<tr>
<td align="center">“Test”.upcase</td>
<td align="center">TEST</td>
</tr>
</tbody></table>
<h5 id="2-2-5-正则表达式与字符操作"><a href="#2-2-5-正则表达式与字符操作" class="headerlink" title="2.2.5 正则表达式与字符操作"></a>2.2.5 正则表达式与字符操作</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">puts <span class="string">"foobar"</span>.sub(<span class="string">"bar"</span>, <span class="string">"foo"</span>)</span><br></pre></td></tr></table></figure>

<p><code>sub</code>将第一个参数替换成第二个参数。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">puts <span class="string">"this is a test string"</span>.gsub(<span class="string">"i"</span>, <span class="string">""</span>)</span><br></pre></td></tr></table></figure>

<p><code>gsub</code>方法会对所有匹配文本进行多次替换。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="string">"this is a test"</span></span><br><span class="line">puts x.sub(<span class="regexp">/^../</span>, <span class="string">"Hello"</span>)</span><br><span class="line">puts x.sub(<span class="regexp">/..$/</span>, <span class="string">"Hello"</span>)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Hellois is a test</span><br><span class="line">this is a teHello</span><br></pre></td></tr></table></figure>

<p>在正则表达式中<code>^</code>，称为锚，表示正则表达式将从字符串中的任一行开头进行匹配，<code>..</code>中每一个点表示”任何字符“，整个表达式表达的是某行开始的开头两个字符，<code>$</code>为另一种锚，表示行尾。</p>
<h4 id="2-3-数组与列表"><a href="#2-3-数组与列表" class="headerlink" title="2.3 数组与列表"></a>2.3 数组与列表</h4><h5 id="2-3-1-基本数组"><a href="#2-3-1-基本数组" class="headerlink" title="2.3.1 基本数组"></a>2.3.1 基本数组</h5><p>在Ruby中，可以用数组(array)来表示对象的有序集合。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">x[<span class="number">2</span>] = <span class="string">"Fish"</span> * <span class="number">3</span></span><br><span class="line">x &lt;&lt; <span class="string">"word"</span></span><br><span class="line">x.push(<span class="number">5</span>)</span><br><span class="line">puts x</span><br></pre></td></tr></table></figure>

<p>对于数组来说，<code>&lt;&lt;</code>就是把数据放到数组末尾的运算符，也可以调用<code>push</code>,具有相同的效果，<code>x.pop</code>表示一处末尾元素。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">puts x.join(<span class="string">","</span>)</span><br></pre></td></tr></table></figure>

<p><code>join</code>表示把数组元素以指定的字符串连接起来。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="string">"this is a test"</span></span><br><span class="line">puts x.split(<span class="string">" "</span>)</span><br></pre></td></tr></table></figure>

<p><code>split</code>表示将字符串以特定的字符串，分割成字符串数组。</p>
<h5 id="2-3-2-数组迭代"><a href="#2-3-2-数组迭代" class="headerlink" title="2.3.2 数组迭代"></a>2.3.2 数组迭代</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x = [<span class="number">1</span>, <span class="string">"test"</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">x.each &#123;<span class="params">|element|</span> puts element.to_s + <span class="string">"X"</span>&#125;</span><br><span class="line"></span><br><span class="line">y = x.collect &#123;<span class="params">|element|</span> element * <span class="number">2</span>&#125;</span><br><span class="line">puts y</span><br></pre></td></tr></table></figure>

<p><code>each</code> 方法遍历数组的每个元素，<code>collect</code>方法对数组进行实时转换。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">x = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">y = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">z = x + y</span><br><span class="line">puts x.empty?</span><br><span class="line">puts x.first</span><br><span class="line">puts x.last</span><br><span class="line">puts x.reverse.inspect</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">false</span><br><span class="line">1</span><br><span class="line">4</span><br><span class="line">[4, 3, 2, 1]</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">y = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">z = x + y</span><br><span class="line">puts z.uniq.inspect</span><br></pre></td></tr></table></figure>

<p>打印结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[1, 2, 3, 4]</span><br></pre></td></tr></table></figure>

<p><code>uniq</code>这个方法是用来移除重复的元素。</p>
<h4 id="2-4-散列表"><a href="#2-4-散列表" class="headerlink" title="2.4 散列表"></a>2.4 散列表</h4><p>数组是对象的集合，散列表亦是。散列表中的对象不在列表给定位置，而是给定一个指向对象的键(key)。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dictionary = &#123;<span class="string">'cat'</span> =&gt; <span class="string">'feline animal'</span>, <span class="string">'dog'</span> =&gt; <span class="string">'canine animal'</span>&#125;</span><br><span class="line">puts dictionary</span><br><span class="line">puts dictionary.size</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;cat&quot;&#x3D;&gt;&quot;feline animal&quot;, &quot;dog&quot;&#x3D;&gt;&quot;canine animal&quot;&#125;</span><br><span class="line">2</span><br></pre></td></tr></table></figure>

<h5 id="2-4-1-散列表的基础方法"><a href="#2-4-1-散列表的基础方法" class="headerlink" title="2.4.1 散列表的基础方法"></a>2.4.1 散列表的基础方法</h5><p>获取散列表元素信息</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x = &#123;<span class="string">'a'</span> =&gt; <span class="number">1</span>, <span class="string">'b'</span> =&gt; <span class="number">2</span>&#125;</span><br><span class="line">x.each &#123; <span class="params">|key, value|</span></span><br><span class="line">	puts <span class="string">"<span class="subst">#&#123;key&#125;</span> equals <span class="subst">#&#123;value&#125;</span>"</span></span><br><span class="line">&#125;</span><br><span class="line">puts <span class="string">"keys: <span class="subst">#&#123;x.keys.inspect&#125;</span> \nvalue: <span class="subst">#&#123;x.values.inspect&#125;</span>"</span></span><br></pre></td></tr></table></figure>

<p>删除元素</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x = &#123;<span class="string">'a'</span> =&gt; <span class="number">1</span>, <span class="string">'b'</span> =&gt; <span class="number">2</span>&#125;</span><br><span class="line">x.delete(<span class="string">"a"</span>)</span><br></pre></td></tr></table></figure>

<p> 有条件地删除元素</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x = &#123;<span class="string">'a'</span> =&gt; <span class="number">1</span>, <span class="string">'b'</span> =&gt; <span class="number">2</span>&#125;</span><br><span class="line">x.delete_if&#123;<span class="params">|key, value|</span> value &lt; <span class="number">2</span>&#125;</span><br><span class="line">puts x.inspect</span><br></pre></td></tr></table></figure>



<h4 id="2-5-流程控制"><a href="#2-5-流程控制" class="headerlink" title="2.5 流程控制"></a>2.5 流程控制</h4><h5 id="2-5-1-if与unless"><a href="#2-5-1-if与unless" class="headerlink" title="2.5.1 if与unless"></a>2.5.1 if与unless</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">age = <span class="number">10</span></span><br><span class="line">puts <span class="string">"you are too young to use this system"</span> <span class="keyword">if</span> age &lt; <span class="number">18</span></span><br><span class="line"><span class="keyword">if</span> age &lt; <span class="number">18</span> </span><br><span class="line">	puts <span class="string">"you are too young to use this system"</span> </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>上面这两种方式功能等同。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">age = <span class="number">10</span></span><br><span class="line">puts <span class="string">"so we are going to exit your program now"</span> <span class="keyword">unless</span> age &gt; <span class="number">18</span></span><br></pre></td></tr></table></figure>

<p><code>unless</code> 是<code>if</code>的反义词。</p>
<h5 id="2-5-2-elsif-与case"><a href="#2-5-2-elsif-与case" class="headerlink" title="2.5.2 elsif 与case"></a>2.5.2 elsif 与case</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">color = <span class="string">"orange"</span></span><br><span class="line"><span class="keyword">if</span> color == <span class="string">"orange"</span></span><br><span class="line">	puts <span class="string">"i like this color"</span></span><br><span class="line"><span class="keyword">elsif</span> color == <span class="string">'green'</span></span><br><span class="line">	puts <span class="string">"i not like"</span></span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">	puts <span class="string">"normal"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>case</code>块首先处理表达式，然后找出匹配该表达式的<code>when</code>块并执行，如果匹配不到<code>when</code>则执行<code>case</code>中的<code>else</code>块</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> color</span><br><span class="line"><span class="keyword">when</span> <span class="string">"orange"</span></span><br><span class="line">	puts <span class="string">"i like this color"</span></span><br><span class="line"><span class="keyword">when</span> <span class="string">"green"</span></span><br><span class="line">	puts <span class="string">"i not like"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	puts <span class="string">"normal"</span>	</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="2-5-3-代码块"><a href="#2-5-3-代码块" class="headerlink" title="2.5.3 代码块"></a>2.5.3 代码块</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">each_vowel</span><span class="params">(&amp;code_block)</span></span></span><br><span class="line">	<span class="string">%w&#123;a e i o u&#125;</span>.each &#123; <span class="params">|vowel|</span> code_block.call(vowel)&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">each_vowel &#123; <span class="params">|vowel|</span></span><br><span class="line">	puts vowel</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>each_vowel</code>接受代码块作为参数，<code>&amp;</code>表示该参数是代码块，<code>call</code>执行传递进来的代码块。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">each_vowel</span><span class="params">(&amp;code_block)</span></span></span><br><span class="line">	<span class="string">%w&#123;a e i o u&#125;</span>.each &#123; <span class="params">|vowel|</span> <span class="keyword">yield</span> vowel&#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>yield</code>会自动检测传递给它的代码块，并将控制权移交给该代码块。</p>
<p>ps：一次只能传递一个代码块，任何方法都不可能接受两个及以上的代码块作为参数，但代码块本身可以接受多个参数。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print_param = lambda &#123; <span class="params">|x|</span> puts x&#125;</span><br><span class="line">print_param.call(<span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p>可以用<code>lambda</code>方法把代码块储存在变量中，用lambda对象的<code>call</code>方法来执行代码块，以及接受传递来的任何参数。</p>
<h4 id="2-6-其他构造元素"><a href="#2-6-其他构造元素" class="headerlink" title="2.6 其他构造元素"></a>2.6 其他构造元素</h4><h5 id="2-6-1-日期与时间"><a href="#2-6-1-日期与时间" class="headerlink" title="2.6.1 日期与时间"></a>2.6.1 日期与时间</h5><p>Ruby提供了<code>Time</code>这个类来处理时间和日期，<code>Time</code>内部机制是用微妙值来保存时间，根据UNIX的时间基准：格林尼治标准时间(GMT)/协调世界时(UTC) 1970年元月1日0时0分0秒。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">puts Time.now</span><br></pre></td></tr></table></figure>

<p>打印结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020-01-28 19:18:51 +0800</span><br></pre></td></tr></table></figure>

<p><code>+0800</code>表示当前时区的时间 </p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">puts Time.local(<span class="string">"2020"</span>, <span class="string">"01"</span>, <span class="string">"27"</span>, <span class="string">"19"</span>, <span class="string">"22"</span>, <span class="string">"00"</span>)</span><br></pre></td></tr></table></figure>

<p><code>Time</code>允许根据当前时区创建一个<code>Time</code>对象，从month开始所有的参数都是可选的。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">puts Time.utc(<span class="string">"2020"</span>, <span class="string">"01"</span>, <span class="string">"27"</span>, <span class="string">"19"</span>, <span class="string">"22"</span>, <span class="string">"00"</span>)</span><br></pre></td></tr></table></figure>

<p>根据GMT/UTC创建<code>Time</code>对象，所需参数与<code>local</code>方法类似。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">seconds = Time.now.to_i</span><br><span class="line">time = Time.at(seconds)</span><br><span class="line"></span><br><span class="line">puts time</span><br><span class="line">puts time.year, time.month</span><br></pre></td></tr></table></figure>

<p>基准时间和<code>Time</code>对象互转，以及获取日期的年、月等相关属性。</p>
<table>
<thead>
<tr>
<th align="center">方法</th>
<th align="center">方法的返回值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">hour</td>
<td align="center">表示24小时格式的数字</td>
</tr>
<tr>
<td align="center">min</td>
<td align="center">分钟数</td>
</tr>
<tr>
<td align="center">sec</td>
<td align="center">秒数</td>
</tr>
<tr>
<td align="center">usec</td>
<td align="center">微秒数</td>
</tr>
<tr>
<td align="center">day</td>
<td align="center">该月第几天</td>
</tr>
<tr>
<td align="center">mday</td>
<td align="center">与day同义</td>
</tr>
<tr>
<td align="center">wday</td>
<td align="center">按周计的天数</td>
</tr>
<tr>
<td align="center">yday</td>
<td align="center">按年计的天数</td>
</tr>
<tr>
<td align="center">month</td>
<td align="center">当年月份</td>
</tr>
<tr>
<td align="center">year</td>
<td align="center">年份</td>
</tr>
<tr>
<td align="center">zone</td>
<td align="center">返回时间关联的时区名</td>
</tr>
<tr>
<td align="center">utc?</td>
<td align="center">根据time判断是否在UTC/GMT时区</td>
</tr>
<tr>
<td align="center">gmt?</td>
<td align="center">与utc?方法同义</td>
</tr>
</tbody></table>
<h3 id="3-类、对象和模块"><a href="#3-类、对象和模块" class="headerlink" title="3. 类、对象和模块"></a>3. 类、对象和模块</h3><h4 id="3-1-面向对象的基础知识"><a href="#3-1-面向对象的基础知识" class="headerlink" title="3.1 面向对象的基础知识"></a>3.1 面向对象的基础知识</h4><h5 id="3-1-1-局部变量、全局变量、实例变量和类变量"><a href="#3-1-1-局部变量、全局变量、实例变量和类变量" class="headerlink" title="3.1.1 局部变量、全局变量、实例变量和类变量"></a>3.1.1 局部变量、全局变量、实例变量和类变量</h5><p>全局变量在程序的任何地方都可以访问，包括在类或对象中，在Ruby中全局变量并不常用，因为它违背了面向对象的思想，在Ruby使用<code>$</code>符号来定义全局变量。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$x = <span class="number">10</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">basic_mehod</span></span></span><br><span class="line">	puts $x</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">basic_mehod</span><br></pre></td></tr></table></figure>

<p>实例变量其作用域关联于当前对象，实例变量有一个<code>@</code>符号前缀。</p>
<p>类变量的作用域处于整个类中，类变量以<code>@@</code>符号为前缀表示。</p>
<h5 id="3-1-2-类方法和对象方法"><a href="#3-1-2-类方法和对象方法" class="headerlink" title="3.1.2 类方法和对象方法"></a>3.1.2 类方法和对象方法</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Square</span></span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">test_method</span></span></span><br><span class="line">		puts <span class="string">"from an instance of the class"</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">test_method</span></span></span><br><span class="line">		puts <span class="string">"from the Square class"</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>self.test_method</code>为类方法，类方法由<code>self.</code>前缀标识，或者也可以使用<code>Square.test_method</code>来定义类方法。</p>
<h5 id="3-1-3-继承"><a href="#3-1-3-继承" class="headerlink" title="3.1.3 继承"></a>3.1.3 继承</h5><p>Ruby中任何类都可以继承另一个类的功能特性，Ruby只支持单继承。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(name)</span></span></span><br><span class="line">		@name = name</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">name</span></span></span><br><span class="line">		@name</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Doctor</span> &lt; Person</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">name</span></span></span><br><span class="line">		<span class="string">"Dr. "</span> + <span class="keyword">super</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>Doctor</code>类覆写<code>name</code>方法，并调用<code>super</code>。</p>
<h5 id="3-1-4-覆写现有方法"><a href="#3-1-4-覆写现有方法" class="headerlink" title="3.1.4 覆写现有方法"></a>3.1.4 覆写现有方法</h5><p>Ruby是一门动态语言，可以覆写现有的类和方法。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">String</span></span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">length</span></span></span><br><span class="line">		<span class="number">20</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">puts <span class="string">"test string"</span>.length</span><br></pre></td></tr></table></figure>

<p>Ruby的一些程序库和扩展（插件）覆写了核心类的方法，以扩展Ruby的通用功能，对于覆写系统提供的方法，还是要小心慎重。</p>
<h5 id="3-1-5-对象方法的反射和发现"><a href="#3-1-5-对象方法的反射和发现" class="headerlink" title="3.1.5 对象方法的反射和发现"></a>3.1.5 对象方法的反射和发现</h5><p>反射是指计算机程序在运行和使用中，检视、分析并修改自身的过程，而Ruby把这种反射用到了极致，允许在运行自己的代码时，修改语言自身的大部分功能。在Ruby中，可以查询几乎任何对象定义的方法。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">puts <span class="string">"test"</span>.methods.join(<span class="string">" "</span>)</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">encode encode! unpack unpack1 include? % * + count partition to_c sum next casecmp casecmp? insert bytesize match match? succ! &lt;&#x3D;&gt; next! upto index replace &#x3D;&#x3D; &#x3D;&#x3D;&#x3D; chr &#x3D;~ rindex [] []&#x3D; byteslice getbyte setbyte clear scrub empty? eql? -@ downcase scrub! dump undump upcase +@ capitalize swapcase upcase! downcase! capitalize! swapcase! hex oct freeze inspect bytes chars codepoints lines reverse reverse! concat split crypt ord length size grapheme_clusters succ start_with? center prepend strip rjust rstrip ljust chomp delete_suffix sub to_str to_sym intern sub! lstrip &lt;&lt; to_s to_i to_f gsub! chop! chomp! delete_prefix gsub chop end_with? scan tr strip! lstrip! rstrip! delete_prefix! delete_suffix! delete! tr_s delete squeeze tr! tr_s! each_grapheme_cluster squeeze! each_line each_byte each_char each_codepoint b slice slice! hash encoding force_encoding unicode_normalize valid_encoding? ascii_only? rpartition unicode_normalize! unicode_normalized? to_r between? &lt;&#x3D; &gt;&#x3D; clamp &lt; &gt; instance_variable_defined? remove_instance_variable instance_of? kind_of? is_a? tap instance_variable_get instance_variable_set instance_variables singleton_method method public_send define_singleton_method public_method extend to_enum enum_for !~ respond_to? object_id send display nil? class singleton_class clone dup itself yield_self then taint tainted? untaint untrust untrusted? trust frozen? methods singleton_methods protected_methods private_methods public_methods equal? ! __id__ instance_exec !&#x3D; instance_eval __send__</span><br></pre></td></tr></table></figure>

<p>对于任何对象，methods方法都返回该对象可用方法的数组。</p>
<h5 id="3-1-6-封装"><a href="#3-1-6-封装" class="headerlink" title="3.1.6 封装"></a>3.1.6 封装</h5><p>封装是指对象将其组成数据隐藏在抽象接口之后的能力，封装的基本原理是向类之外尽可能少地减少暴露方法。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(name)</span></span></span><br><span class="line">		set_name(name)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">name</span></span></span><br><span class="line">		@first_name + <span class="string">' '</span>+ @last_name</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	private</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">set_name</span><span class="params">(name)</span></span></span><br><span class="line">		first_name, last_name = name.split(<span class="regexp">/\s+/</span>)</span><br><span class="line">		set_first_name(first_name)</span><br><span class="line">		set_last_name(last_name)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">set_first_name</span><span class="params">(name)</span></span></span><br><span class="line">		@first_name = name</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">set_last_name</span><span class="params">(name)</span></span></span><br><span class="line">		@last_name = name</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>private</code>关键字的作用就是class之外的代码无法访问，与其他语言的类似。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private <span class="symbol">:set_name</span>, <span class="symbol">:set_first_name</span>, <span class="symbol">:set_last_name</span></span><br></pre></td></tr></table></figure>

<p>也可以把<code>private</code>当成命令使用，向其传递一组符号参数，表示想把这些符号表示的方法设置为私有。</p>
<h5 id="3-1-7-多态"><a href="#3-1-7-多态" class="headerlink" title="3.1.7 多态"></a>3.1.7 多态</h5><p>多态的概念是指编写代码可以同时适用于多种类型和类的对象，如 <code>+</code>方法适用于数据相加、字符串相连以及数组合并等，<code>+</code>方法具体操作什么，完全依赖于具体类型。</p>
<h5 id="3-1-8-嵌套类"><a href="#3-1-8-嵌套类" class="headerlink" title="3.1.8 嵌套类"></a>3.1.8 嵌套类</h5><p>在Ruby中，可以把类放入其他类中，这样的类称为嵌套(nested)类。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Drawing</span></span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">get_circle</span></span></span><br><span class="line">		Circle.new</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Line</span></span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Circle</span></span></span><br><span class="line">		<span class="function"><span class="keyword">def</span> <span class="title">desc</span></span></span><br><span class="line">			<span class="string">"this is a circle"</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">d = Drawing.get_circle</span><br><span class="line">c = Drawing::Circle.new</span><br><span class="line"></span><br><span class="line">puts d.desc</span><br><span class="line">puts c.desc</span><br></pre></td></tr></table></figure>

<p>嵌套类只能以<code>::</code>的形式创建。</p>
<h5 id="3-1-8-常量的作用域"><a href="#3-1-8-常量的作用域" class="headerlink" title="3.1.8 常量的作用域"></a>3.1.8 常量的作用域</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Pi = <span class="number">3.141592</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Planet</span></span></span><br><span class="line">	Pi = <span class="number">3.14</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">circle</span><span class="params">(radius)</span></span></span><br><span class="line">		<span class="number">2</span> * Pi * radius</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">puts Planet::Pi</span><br><span class="line">puts Pi</span><br></pre></td></tr></table></figure>

<p>在类中定义的常量，其作用域在类的环境中，通过<code>Planet::Pi</code>方式调用。</p>
<h5 id="3-1-9-判断对象的类型"><a href="#3-1-9-判断对象的类型" class="headerlink" title="3.1.9 判断对象的类型"></a>3.1.9 判断对象的类型</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">puts <span class="string">"hello"</span>.is_a? Object</span><br><span class="line">puts <span class="string">"hello"</span>.kind_of? Object</span><br><span class="line">puts <span class="string">"hello"</span>.instance_of?Object</span><br><span class="line">puts <span class="string">"hello"</span>.instance_of? String</span><br></pre></td></tr></table></figure>

<p>打印结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">true</span><br><span class="line">false</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p><code>is_a?</code>和<code>kind_of?</code>是同义的，<code>instance_of?</code>与这个两个不同的是，只在对象是那个类的实例而不是子类时才返回true。</p>
<h4 id="3-2-模块、命名空间和渗入"><a href="#3-2-模块、命名空间和渗入" class="headerlink" title="3.2 模块、命名空间和渗入"></a>3.2 模块、命名空间和渗入</h4><p>模块提供了一种结构，用来把Ruby类、方法和常量收集到单独命名和定义的单元中，这样可以避免与现有类、方法和常量发生命名冲突。</p>
<h5 id="3-2-1-命名空间"><a href="#3-2-1-命名空间" class="headerlink" title="3.2.1 命名空间"></a>3.2.1 命名空间</h5><p>在number_stuff.rb和letter_stuff.rb分别分别存在<code>random</code>方法如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># number_stuff.rb</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">random</span></span></span><br><span class="line">	rand(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># letter_stuff.rb</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">random</span></span></span><br><span class="line">	(rand(<span class="number">26</span>) + <span class="number">65</span>).chr</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>遇到如下的场景，加载的两个文件都存在同一个方法<code>random</code>:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'./number_stuff.rb'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'./letter_stuff.rb'</span></span><br><span class="line"></span><br><span class="line">puts random</span><br></pre></td></tr></table></figure>

<p>打印结果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">M</span><br></pre></td></tr></table></figure>

<p>由于最后一个文件(letter_stuff.rb)被载入，因此结果时使用最后一个版本的<code>random</code>方法。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">NumberStuff</span></span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">NumberStuff</span>.<span class="title">random</span></span></span><br><span class="line">		rand(<span class="number">100</span>)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">LetterStuff</span></span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">LetterStuff</span>.<span class="title">random</span></span></span><br><span class="line">		(rand(<span class="number">26</span>) + <span class="number">65</span>).chr</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>可以用<code>module</code>来解决命名冲突的问题，它提供了命名空间。</p>
<h5 id="3-2-2-渗入"><a href="#3-2-2-渗入" class="headerlink" title="3.2.2 渗入"></a>3.2.2 渗入</h5><p>在Ruby中不支持多继承，但在某些情况，需要从不同的类中共享功能，类似swift中的协议，在这种意义上，模块像某种“超级”类，可被包含到其他类中，用模块提供的功能来扩展其他类。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">UsefulFeatures</span></span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">class_name</span></span></span><br><span class="line">		<span class="keyword">self</span><span class="class">.<span class="keyword">class</span>.<span class="title">to_s</span></span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line">	<span class="keyword">include</span> UsefulFeatures</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">p = Person.new</span><br><span class="line">puts p.class_name</span><br></pre></td></tr></table></figure>

<p><code>UsefulFeatures</code>模块看起来几乎像个“类”，不过模块本身就是组织工具，而不是类，<code>class_name</code>方法位于模块中，因此随即被包含在<code>Person</code>类中。<code>include</code>命名是把模块的内容放到当前作用域中。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">A</span></span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">a1</span></span></span><br><span class="line">		puts <span class="string">"this is a1"</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">B</span></span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">b1</span></span></span><br><span class="line">		puts <span class="string">"this is b1"</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sample</span></span></span><br><span class="line">	<span class="keyword">include</span> A</span><br><span class="line">	<span class="keyword">include</span> B</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">s1</span></span></span><br><span class="line">		puts <span class="string">"this is Sample"</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">s = Sample.new</span><br><span class="line">s.a1</span><br><span class="line">s.b1</span><br><span class="line">s.s1</span><br></pre></td></tr></table></figure>

<p>打印结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">this is a1</span><br><span class="line">this is b1</span><br><span class="line">this is Sample</span><br></pre></td></tr></table></figure>



<p>前面提到的<code>Kernel</code>模块包含所有的标准命令，在Ruby中无须指定对象或者类，如<code>load</code>、<code>require</code>、<code>exit</code>等，它们是特殊的方法，通过<code>Kernel</code>模块，被默认包含所有类（包括主程序作用）中。</p>
<p>除了<code>Kernel</code>模块，系统还提供了<code>Enmerable</code>、<code>Comparable</code>模块，<code>Enmerable</code>提供的主要是与迭代瞎相关的功能，如<code>each</code>、<code>sort</code>、<code>max</code>、<code>min</code>等，<code>Comparable</code>为其他类提供比较运算符。</p>
<h3 id="4-部署Ruby应用和程序库"><a href="#4-部署Ruby应用和程序库" class="headerlink" title="4. 部署Ruby应用和程序库"></a>4. 部署Ruby应用和程序库</h3><h4 id="4-1-Ruby程序发布"><a href="#4-1-Ruby程序发布" class="headerlink" title="4.1 Ruby程序发布"></a>4.1 Ruby程序发布</h4><h4 id="4-2-检测Ruby运行环境"><a href="#4-2-检测Ruby运行环境" class="headerlink" title="4.2 检测Ruby运行环境"></a>4.2 检测Ruby运行环境</h4><h4 id="4-3-以gem包形式发布Ruby程序库"><a href="#4-3-以gem包形式发布Ruby程序库" class="headerlink" title="4.3 以gem包形式发布Ruby程序库"></a>4.3 以gem包形式发布Ruby程序库</h4><h3 id="5-Ruby的高级功能"><a href="#5-Ruby的高级功能" class="headerlink" title="5. Ruby的高级功能"></a>5. Ruby的高级功能</h3><h4 id="5-1-动态代码执行"><a href="#5-1-动态代码执行" class="headerlink" title="5.1 动态代码执行"></a>5.1 动态代码执行</h4><h4 id="5-2-Ruby运行其他程序"><a href="#5-2-Ruby运行其他程序" class="headerlink" title="5.2 Ruby运行其他程序"></a>5.2 Ruby运行其他程序</h4><h3 id="6-Ruby-on-Rails-Ruby的杀手级应用"><a href="#6-Ruby-on-Rails-Ruby的杀手级应用" class="headerlink" title="6. Ruby on Rails: Ruby的杀手级应用"></a>6. Ruby on Rails: Ruby的杀手级应用</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/liututu1213/liututu1213.github.io/blog/blog/posts/2020/01/05/Date/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liututu1213">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="渣渣程序员">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/posts/2020/01/05/Date/" itemprop="url">Date</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-05T00:05:39+08:00">
                2020-01-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/swift/" itemprop="url" rel="index">
                    <span itemprop="name">swift</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="1-UTC、GMT和时间戳介绍"><a href="#1-UTC、GMT和时间戳介绍" class="headerlink" title="1. UTC、GMT和时间戳介绍"></a>1. UTC、GMT和时间戳介绍</h4><h5 id="GMT"><a href="#GMT" class="headerlink" title="GMT"></a>GMT</h5><p>格林尼治标准时间（Greenwich Mean Time）是指位于英国伦敦郊区的皇家格林尼治天文台的标准时间，即本初子午线时间。</p>
<p>由于地球在椭圆轨道里的运动速度不均匀，这个时刻可能与实际的太阳时有误差，所以有了UTC时间出现。</p>
<h5 id="UTC"><a href="#UTC" class="headerlink" title="UTC"></a>UTC</h5><p>协调世界时间（又称世界标准时间），与GMT一样都是本初子午时间，只不过UTC是经过协调后的世界时间，比GMT更加准确。全球一共有24个时区。</p>
<p><img src="https://raw.githubusercontent.com/CathyLy/imageForSource/master/2020/timezone.png" alt="timezone"></p>
<p>而北京时间位于东八区，与格林尼治时间相差八小时，也就是我们经常在开发中遇到8小时时差的问题。</p>
<h4 id="2-swift中Date与Calender关系"><a href="#2-swift中Date与Calender关系" class="headerlink" title="2. swift中Date与Calender关系"></a>2. swift中Date与Calender关系</h4><p><img src="https://raw.githubusercontent.com/liututu1213/imageForSource/master/2020/date-calender.png" alt=""></p>
<p>首先Date可以通过DateFormatter进行互转，Date通过格式化可以转化成自定义的样式，反过来同样成立。在iOS中，没办法像其他语言一样直接time.year这样的api获取年份等信息，想要获取Date的年月日信息需要使用Calende+DateCompontents来完成，反之，也可以通过DateComponents对各个组件进行组装，通过Calender对象变成date。</p>
<p>Calender封装了有关计算时间的系统的信息，其中定义了年的开始、长度和分割，提供了关于日历的信息和日历计算的支持。</p>
<h4 id="3-Date"><a href="#3-Date" class="headerlink" title="3. Date"></a>3. Date</h4><p>iOS中的Date是用来表示公历的GMT时间，Date是没有存储时区等信息，所以不管你在哪个时区打印的Date()都是一样的，这一点非常重要。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> date = <span class="type">Date</span>()</span><br><span class="line"><span class="built_in">print</span>(date)</span><br></pre></td></tr></table></figure>

<p>打印结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020-01-04 10:03:01 +0000</span><br></pre></td></tr></table></figure>

<p>Date()获取的是零时区的时间(格林尼治的时间)，而如果你系统所在的时区是东八区即北京时间，则实际系统时间与打印出来的时间相差八小时。</p>
<p>Date的初始化方法：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>()</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(timeIntervalSinceNow: <span class="type">TimeInterval</span>) <span class="comment">//以当前时间的偏移秒数来初始化</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(timeIntervalSince1970: <span class="type">TimeInterval</span>) <span class="comment">//以GMT时间的偏移秒数来初始化</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(timeInterval: <span class="type">TimeInterval</span>, since date: <span class="type">Date</span>) <span class="comment">//以给定秒数返回相对于另一个给定日期初始化的“日期”</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<p>时间比较相关方法：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">compare</span><span class="params">(<span class="number">_</span> other: Date)</span></span> -&gt; <span class="type">ComparisonResult</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> == <span class="params">(lhs: Date, rhs: Date)</span></span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> &lt; (lhs: Date, rhs: Date) -&gt; <span class="title">Bool</span></span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">func</span> &gt; <span class="params">(lhs: Date, rhs: Date)</span></span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> + <span class="params">(lhs: Date, rhs: TimeInterval)</span></span> -&gt; <span class="type">Date</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h5 id="时间戳"><a href="#时间戳" class="headerlink" title="时间戳"></a>时间戳</h5><p>时间戳是指1970-01-01 00:00:00到当前时间的秒数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">date.timeIntervalSince1970 </span><br><span class="line">date.timeIntervalSinceNow</span><br><span class="line">date.timeIntervalSince(xx)</span><br></pre></td></tr></table></figure>



<h4 id="4-DateFormatter-Date-与String-互相转换"><a href="#4-DateFormatter-Date-与String-互相转换" class="headerlink" title="4. DateFormatter: Date 与String 互相转换"></a>4. DateFormatter: Date 与String 互相转换</h4><p>DateFormatter 是Formatter的子类，Formatter是将数据在字符串与特定类型的对象之间转换，目前Formatter有两个子类NumberFormatter和DateFormatter。</p>
<p>DateFormatter用来在日期和字符串之间的转换，DateFormatter格式其实是遵守了Unicode Technical Standard。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="keyword">var</span> dateFormat: <span class="type">String!</span></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">var</span> dateStyle: <span class="type">DateFormatter</span>.<span class="type">Style</span></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">var</span> timeStyle: <span class="type">DateFormatter</span>.<span class="type">Style</span></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">var</span> locale: <span class="type">Locale!</span></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">var</span> timeZone: <span class="type">TimeZone!</span></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">var</span> calendar: <span class="type">Calendar!</span> <span class="comment">//如果未指定则使用当前用户的逻辑日历</span></span><br></pre></td></tr></table></figure>

<p>下面将会来一一介绍这些相关的属性。</p>
<p>DateFormatter提供了许多定义好的时间格式，如dateStyle和timeStyle。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Style</span> : <span class="title">UInt</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">none</span></span><br><span class="line">    <span class="keyword">case</span> short</span><br><span class="line">    <span class="keyword">case</span> medium</span><br><span class="line">    <span class="keyword">case</span> long</span><br><span class="line">    <span class="keyword">case</span> full</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">格式类型</th>
<th align="center">dateStyle</th>
<th align="center">timeStyle</th>
</tr>
</thead>
<tbody><tr>
<td align="center">none</td>
<td align="center">/</td>
<td align="center">/</td>
</tr>
<tr>
<td align="center">short</td>
<td align="center">1/4/20</td>
<td align="center">7:37 PM</td>
</tr>
<tr>
<td align="center">medium</td>
<td align="center">Jan 4, 2020</td>
<td align="center">7:38:51 PM</td>
</tr>
<tr>
<td align="center">long</td>
<td align="center">January 4, 2020</td>
<td align="center">7:39:50 PM GMT+8</td>
</tr>
<tr>
<td align="center">full</td>
<td align="center">Saturday, January 4, 2020</td>
<td align="center">7:40:40 PM China Standard Time</td>
</tr>
</tbody></table>
<p>DateFormatter有一个local的属性，Local是与国际化相关的基础类。</p>
<h4 id="5-Local"><a href="#5-Local" class="headerlink" title="5. Local"></a>5. Local</h4><p>Local是是与国际化相关的基础类，在OS X中，可以到”系统偏好设置-&gt;语言与地区”中设置当前的local。Local是包含所有地区的语言与文化习俗的基础类，一个Local实例包含了针对这个地区内特定一群人的所有语言文化基准，其中包括：</p>
<ul>
<li>语言</li>
<li>键盘</li>
<li>数字、日期和时间格式</li>
<li>货币  如USD</li>
<li>排序和分类</li>
<li>符号、颜色与头像的使用</li>
</ul>
<p>每一个Local的实例对应着一个地区标识符，如en_US、zh_CN等，这些标识符包含 语言码(en)和地区码(US)。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Locale</span>.preferredLanguages <span class="comment">//返回用户偏好设置的语言列表</span></span><br></pre></td></tr></table></figure>



<h4 id="6-TimeZone"><a href="#6-TimeZone" class="headerlink" title="6. TimeZone"></a>6. TimeZone</h4><p>TimeZone表示时区信息，上面提到过世界上有24是个时区，任何时区都是GMT为基准，TimeZone对象所代表的时区都是相对于GMT的。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> current: <span class="type">TimeZone</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>?(identifier: <span class="type">String</span>) <span class="comment">//用给定的标识符初始化timeZone对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>?(secondsFromGMT seconds: <span class="type">Int</span>) <span class="comment">//通过相对于GMT时间偏移量(时差)来获取时区</span></span><br></pre></td></tr></table></figure>



<p>一般应用程序的默认时区，是和手机系统设置的时区一致的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TimeZone.current</span><br></pre></td></tr></table></figure>

<p>打印结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">▿ Asia&#x2F;Shanghai (current)</span><br><span class="line">  - identifier : &quot;Asia&#x2F;Shanghai&quot;</span><br><span class="line">  - kind : &quot;current&quot;</span><br><span class="line">  ▿ abbreviation : Optional&lt;String&gt;</span><br><span class="line">    - some : &quot;GMT+8&quot;</span><br><span class="line">  - secondsFromGMT : 28800 &#x2F;&#x2F;相对于GMT的时差 秒</span><br><span class="line">  - isDaylightSavingTime : false</span><br></pre></td></tr></table></figure>



<h4 id="7-DateComponents"><a href="#7-DateComponents" class="headerlink" title="7. DateComponents"></a>7. DateComponents</h4><p>这个类可用于计算未来或过去的日期，Calender用它来实现Date和DateComponents相互转换</p>
<h4 id="8-Calendar"><a href="#8-Calendar" class="headerlink" title="8. Calendar"></a>8. Calendar</h4><p>在iOS中，没办法像其他语言一样直接time.year这样的api获取年份等信息，想要获取Date的年月日需要使用Calender的日历对象。Calender封装了有关计算时间的系统的信息，其中定义了年的开始、长度和分割，提供了关于日历的信息和日历计算的支持。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> current: <span class="type">Calendar</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> autoupdatingCurrent: <span class="type">Calendar</span> &#123; <span class="keyword">get</span> &#125; <span class="comment">//当前系统设置的日历的值</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(identifier: <span class="type">Calendar</span>.<span class="type">Identifier</span>) <span class="comment">//Identifier 是一个枚举，提供了各种类型的日历</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">component</span><span class="params">(<span class="number">_</span> component: Calendar.Component, from date: Date)</span></span> -&gt; <span class="type">Int</span> <span class="comment">//返回一个给定date的日期组件</span></span><br></pre></td></tr></table></figure>



<p>先来介绍Calender的相关的api</p>
<h5 id="8-1-Calendar-Identifier"><a href="#8-1-Calendar-Identifier" class="headerlink" title="8.1  Calendar.Identifier"></a>8.1  Calendar.Identifier</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Identifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> gregorian <span class="comment">//公历 Calender的默认值</span></span><br><span class="line">    <span class="keyword">case</span> buddhist</span><br><span class="line">    <span class="keyword">case</span> chinese <span class="comment">//农历</span></span><br><span class="line">    <span class="keyword">case</span> coptic</span><br><span class="line">    <span class="keyword">case</span> ethiopicAmeteMihret</span><br><span class="line">    <span class="keyword">case</span> ethiopicAmeteAlem</span><br><span class="line">    <span class="keyword">case</span> hebrew</span><br><span class="line">    <span class="keyword">case</span> iso8601</span><br><span class="line">    <span class="keyword">case</span> indian</span><br><span class="line">    <span class="keyword">case</span> islamic</span><br><span class="line">    <span class="keyword">case</span> islamicCivil</span><br><span class="line">    <span class="keyword">case</span> japanese</span><br><span class="line">    <span class="keyword">case</span> persian</span><br><span class="line">    <span class="keyword">case</span> republicOfChina</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="8-2-Calendar-Component"><a href="#8-2-Calendar-Component" class="headerlink" title="8.2 Calendar.Component"></a>8.2 Calendar.Component</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> era <span class="comment">// 特定时期的时代，取决于日期的日历系统</span></span><br><span class="line">    <span class="keyword">case</span> year</span><br><span class="line">    <span class="keyword">case</span> month</span><br><span class="line">    <span class="keyword">case</span> day</span><br><span class="line">    <span class="keyword">case</span> hour</span><br><span class="line">    <span class="keyword">case</span> minute</span><br><span class="line">    <span class="keyword">case</span> second</span><br><span class="line">    <span class="keyword">case</span> weekday <span class="comment">//星期几，默认情况下周日为1，周一为2，以此类推</span></span><br><span class="line">    <span class="keyword">case</span> weekdayOrdinal <span class="comment">//表示指定日期是当前这个月的第几个星期几，如2020-02-13，星期四，是这个月的第2个星期四</span></span><br><span class="line">    <span class="keyword">case</span> quarter <span class="comment">//返回季度单位的数字，但不同地区季度的起始时间不同，因此此属性默认是0，除非赋值。</span></span><br><span class="line">    <span class="keyword">case</span> weekOfMonth <span class="comment">//Identifier for the week of the month calendar unit.</span></span><br><span class="line">    <span class="keyword">case</span> weekOfYear<span class="comment">// Identifier for the week of the year unit.</span></span><br><span class="line">    <span class="keyword">case</span> yearForWeekOfYear <span class="comment">//Identifier for the week-counting year unit.</span></span><br><span class="line">    <span class="keyword">case</span> nanosecond</span><br><span class="line">    <span class="keyword">case</span> calendar</span><br><span class="line">    <span class="keyword">case</span> timeZone</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Date类是无法单独来获取每一个元素的信息，必须使用component方法获取给定日期的日期组件即Calendar.Component，获取某个时间点对应的”年”、”月”、”日”、”第几周”、”周几”等信息。</p>
<h5 id="8-3-Calender相关函数"><a href="#8-3-Calender相关函数" class="headerlink" title="8.3 Calender相关函数"></a>8.3 Calender相关函数</h5><p><code>public func minimumRange(of component: Calendar.Component) -&gt; Range&lt;Int&gt;?</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> calendar = <span class="type">Calendar</span>.current</span><br><span class="line"><span class="keyword">let</span> range = calendar.minimumRange(of: .day)</span><br><span class="line"><span class="built_in">print</span>(range) <span class="comment">//Range(1..&lt;29)</span></span><br></pre></td></tr></table></figure>

<p>返回指定组件最小的限制范围，如Day Components 最小的范围是1-28</p>
<p><code>public func maximumRange(of component: Calendar.Component) -&gt; Range&lt;Int&gt;?</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> calendar = <span class="type">Calendar</span>.current</span><br><span class="line"><span class="keyword">let</span> range = calendar.maximumRange(of: .day)</span><br><span class="line"><span class="built_in">print</span>(range) <span class="comment">// Range(1..&lt;32)</span></span><br></pre></td></tr></table></figure>

<p>date所在的小组件在 大组件里的范围。</p>
<p><code>public func range(of smaller: Calendar.Component, in larger: Calendar.Component, for date: Date) -&gt; Range&lt;Int&gt;?</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> date = <span class="type">Date</span>() <span class="comment">///"Feb 14, 2020 at 1:10 AM"</span></span><br><span class="line"><span class="keyword">let</span> calendar = <span class="type">Calendar</span>.current</span><br><span class="line"><span class="keyword">let</span> range = calendar.range(of: .day, <span class="keyword">in</span>: .month, <span class="keyword">for</span>: date)</span><br><span class="line"><span class="built_in">print</span>(range) <span class="comment">/// Range(1..&lt;30)</span></span><br></pre></td></tr></table></figure>

<p>返回指定日期所在的小组件在大组件的一个时间范围。</p>
<p><code>public func dateInterval(of component: Calendar.Component, start: inout Date, interval: inout TimeInterval, for date: Date) -&gt; Bool</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> date = <span class="type">Date</span>() <span class="comment">///Feb 14, 2020 at 1:14 AM</span></span><br><span class="line"><span class="keyword">let</span> calendar = <span class="type">Calendar</span>.current</span><br><span class="line"><span class="keyword">var</span> d: <span class="type">Date</span> = <span class="type">Date</span>()</span><br><span class="line"><span class="keyword">var</span> time: <span class="type">Double</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 当前时间所在的一周的开始时间，周日为每周的开始时间</span></span><br><span class="line">calendar.dateInterval(of: .weekOfMonth, start: &amp;d, interval: &amp;time, <span class="keyword">for</span>: date)</span><br><span class="line"><span class="built_in">print</span>(d)</span><br><span class="line"><span class="built_in">print</span>(time)</span><br></pre></td></tr></table></figure>

<p>打印结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-02-08 16:00:00 +0000</span><br><span class="line">604800.0</span><br></pre></td></tr></table></figure>

<p>通过两个inout参数返回包含给定日期、组件的开始时间和时间长。</p>
<p><code>public func ordinality(of smaller: Calendar.Component, in larger: Calendar.Component, for date: Date) -&gt; Int?</code></p>
<p> 返回指定的日期 指定的较小日历组件(Day)在较大日历组件(weekOfMonth) 的序号。</p>
<p><code>public func date(byAdding components: DateComponents, to date: Date, wrappingComponents: Bool = false) -&gt; Date?</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> date = <span class="type">Date</span>() <span class="comment">///2020-02-13 17:29:35 +0000</span></span><br><span class="line"><span class="keyword">let</span> calendar = <span class="type">Calendar</span>.current</span><br><span class="line"><span class="keyword">var</span> dateComponets = <span class="type">DateComponents</span>()</span><br><span class="line">dateComponets.day = <span class="number">18</span></span><br><span class="line"><span class="keyword">let</span> day = calendar.date(byAdding: dateComponets, to: date)!</span><br><span class="line"><span class="built_in">print</span>(day) <span class="number">2020</span>-<span class="number">03</span>-<span class="number">02</span> <span class="number">17</span>:<span class="number">29</span>:<span class="number">35</span> +<span class="number">0000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> day2 = calendar.date(byAdding: dateComponets, to: date, wrappingComponents: <span class="literal">true</span>)!</span><br><span class="line"><span class="built_in">print</span>(day2) <span class="comment">///2020-02-02 17:29:35 +0000</span></span><br></pre></td></tr></table></figure>

<p>向给定日期添加组件计算出新的日期，其中<code>wrappingComponents</code>为true表示组件在增加的时候溢出时，不是向更高的组件”进位”</p>
<p><code>public func date(from components: DateComponents) -&gt; Date?</code></p>
<p>用指定的DateComponents创建一个新的日期，如果匹配不到组件的日期，则返回nil。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">dateComponents</span><span class="params">(<span class="number">_</span> components: Set&lt;Calendar.Component&gt;, from date: Date)</span></span> -&gt; <span class="type">DateComponents</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">dateComponents</span><span class="params">(<span class="keyword">in</span> timeZone: TimeZone, from date: Date)</span></span> -&gt; <span class="type">DateComponent</span></span><br></pre></td></tr></table></figure>

<p>返回这个日历时区所有的日历组件，第一个是传入指定的Calendar.Component数组，第二个是传入TimeZone</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">dateComponents</span><span class="params">(<span class="number">_</span> components: Set&lt;Calendar.Component&gt;, from start: Date, to end: Date)</span></span> -&gt; <span class="type">DateComponents</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">dateComponents</span><span class="params">(<span class="number">_</span> components: Set&lt;Calendar.Component&gt;, from start: DateComponents, to end: DateComponents)</span></span> -&gt; <span class="type">DateComponents</span></span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public func component(_ component: Calendar.Component, from date: Date) -&gt; Int</span><br></pre></td></tr></table></figure>

<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> date = <span class="type">Date</span>() <span class="comment">//2020-02-15 07:14:06 +0000</span></span><br><span class="line"><span class="keyword">let</span> calendar = <span class="type">Calendar</span>.current</span><br><span class="line"><span class="keyword">let</span> startOfDay = calendar.startOfDay(<span class="keyword">for</span>: date)</span><br><span class="line"><span class="built_in">print</span>(startOfDay) <span class="comment">//2020-02-14 16:00:00 +0000</span></span><br></pre></td></tr></table></figure>

<p>返回给定日期的第一个时刻。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">compare</span><span class="params">(<span class="number">_</span> date1: Date, to date2: Date, toGranularity component: Calendar.Component)</span></span> -&gt; <span class="type">ComparisonResult</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">isDate</span><span class="params">(<span class="number">_</span> date1: Date, equalTo date2: Date, toGranularity component: Calendar.Component)</span></span> -&gt; <span class="type">Bool</span></span><br></pre></td></tr></table></figure>

<p>component用于比较的粒度，如.hour 判断两个日期是否在相同的小时内。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">isDate</span><span class="params">(<span class="number">_</span> date1: Date, inSameDayAs date2: Date)</span></span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">isDateInToday</span><span class="params">(<span class="number">_</span> date: Date)</span></span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">isDateInYesterday</span><span class="params">(<span class="number">_</span> date: Date)</span></span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">isDateInTomorrow</span><span class="params">(<span class="number">_</span> date: Date)</span></span> -&gt; <span class="type">Bool</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">isDateInWeekend</span><span class="params">(<span class="number">_</span> date: Date)</span></span> -&gt; <span class="type">Bool</span></span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public func dateIntervalOfWeekend(containing date: Date) -&gt; DateInterval?</span><br></pre></td></tr></table></figure>



<p>使用Calender和Components对Date进行的扩展：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Date</span> </span>&#123;</span><br><span class="line">     <span class="keyword">var</span> startOfWeek: <span class="type">Date</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> calendar = <span class="type">Calendar</span>.current</span><br><span class="line">        <span class="keyword">let</span> component = calendar.dateComponents([.yearForWeekOfYear, .weekOfYear, .hour], from: <span class="keyword">self</span>)</span><br><span class="line">        calendar.firstWeekday = <span class="number">2</span></span><br><span class="line">        <span class="keyword">return</span> calendar.date(from: component)!</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> startOfCurrentMonth: <span class="type">Date</span> &#123;</span><br><span class="line">         <span class="keyword">let</span> calendar = <span class="type">NSCalendar</span>.current</span><br><span class="line">         <span class="keyword">let</span> components = calendar.dateComponents([.year, .month, .hour], from: <span class="keyword">self</span>)</span><br><span class="line">         <span class="keyword">let</span> startOfMonth = calendar.date(from: components)!</span><br><span class="line">         <span class="keyword">return</span> startOfMonth</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>startOfWeek获取一周开始的日期，<code>calendar.firstWeekday = 2</code>用于设置一周从周一开始算起；startOfCurrentMonth获取当前日期所在的月开始时间。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/liututu1213/liututu1213.github.io/blog/blog/posts/2019/12/31/PromiseKit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liututu1213">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="渣渣程序员">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/posts/2019/12/31/PromiseKit/" itemprop="url">PromiseKit</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-12-31T01:01:25+08:00">
                2019-12-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/swift/" itemprop="url" rel="index">
                    <span itemprop="name">swift</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="Promise中的swift用法"><a href="#Promise中的swift用法" class="headerlink" title="Promise中的swift用法"></a>Promise中的swift用法</h4><h5 id="使用type-inference推导泛型参数"><a href="#使用type-inference推导泛型参数" class="headerlink" title="使用type inference推导泛型参数"></a>使用type inference推导泛型参数</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Promise</span>&lt;<span class="title">T</span>&gt;: <span class="title">Thenable</span>, <span class="title">CatchMixin</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">init</span>&lt;<span class="type">U</span>: <span class="type">Thenable</span>&gt;(<span class="number">_</span> bridge: <span class="type">U</span>) <span class="keyword">where</span> <span class="type">U</span>.<span class="type">T</span> == <span class="type">T</span> &#123;</span><br><span class="line">    box = <span class="type">EmptyBox</span>()</span><br><span class="line">    bridge.pipe(to: box.seal)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmptyBox</span>&lt;<span class="title">T</span>&gt;: <span class="title">Box</span>&lt;<span class="title">T</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>在Promise.swift中，<code>EmptyBox</code>是一个泛型类，<code>init</code>方法创建<code>EmptyBox</code>的实例的时候，没有指定类型参数。</p>
<p>对于<code>EmptyBox&lt;T&gt;</code>中的<code>T</code>具体是依据Promise中对于box这个属性的定义：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> box: <span class="type">Box</span>&lt;<span class="type">Result</span>&lt;<span class="type">T</span>&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>有了这个定义，则可以通过<code>EmptyBox()</code>这样的表达式通过编译，type inference 就会自动把EmptyBox的泛型参数推导为Result&lt;T&gt;。</p>
<p>在某些泛型代码里，面对type inference 推导出来的类型，可以用更为简洁的方式调用init，如<a href="https://github.com/mxcl/PromiseKit/blob/master/Sources/Box.swift">Box.swift</a>  中的用法：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Sealant</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> pending(<span class="type">Handlers</span>&lt;<span class="type">R</span>&gt;)</span><br><span class="line">    <span class="keyword">case</span> resolved(<span class="type">R</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Handlers</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> bodies: [(<span class="type">R</span>) -&gt; <span class="type">Void</span>] = []</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(<span class="number">_</span> item: @escaping<span class="params">(R)</span></span></span> -&gt; <span class="type">Void</span>) &#123; bodies.append(item) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmptyBox</span>&lt;<span class="title">T</span>&gt;: <span class="title">Box</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> sealant = <span class="type">Sealant</span>&lt;<span class="type">T</span>&gt;.pending(.<span class="keyword">init</span>())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Sealant&lt;T&gt;.pending</code>创建一个enum对象，case pending有一个关联值，<code>Handlers&lt;R&gt;</code>，由于Handlers有默认的init的方法，可以先依靠type inference推断出<code>.pending()</code>里需要的参数类型。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//等价</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> sealant = <span class="type">Sealant</span>&lt;<span class="type">T</span>&gt;.pending(.<span class="keyword">init</span>())</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> sealant = <span class="type">Sealant</span>&lt;<span class="type">T</span>&gt;.pending(<span class="type">Handlers</span>.<span class="keyword">init</span>())</span><br></pre></td></tr></table></figure>

<p><code>Sealant</code>和<code>Handlers</code>在Promise中算是原子类型，其中<code>Handlers</code>用于保存处理Promise结果的<code>Handlers</code>，泛型参数R表示Promise的结果，在Handlers的定义中的<code>bodies</code>保存了所有对这个结果感兴趣的方法，在Promise的范式里，新的closure会经过一些列方法，最红由append方法加入到bodies。</p>
<p><code>Sealant</code>可以理解为Promise状态的类型，它的泛型参数<code>R</code>和关联值<code>Handlers</code>中的<code>R</code>是表示相同的含义，都是表示Promise的结果。当一个Promise还在等待结果的时候状态则为<code>.pending</code>，它的关联值就是所有对这个结果有所期待的handlers，如果Promise被满足，状态则改变为<code>.resolved</code>，此时的关联值就包含了Promise期望的值。</p>
<h4 id="Box"><a href="#Box" class="headerlink" title="Box"></a>Box</h4><p>在Box的继承体系中，一共有三个类：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Box</span>&lt;<span class="title">T</span>&gt; </span>&#123;&#125;</span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SealedBox</span>&lt;<span class="title">T</span>&gt;: <span class="title">Box</span>&lt;<span class="title">T</span>&gt; </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmptyBox</span>&lt;<span class="title">T</span>&gt;: <span class="title">Box</span>&lt;<span class="title">T</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Box</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">inspect</span><span class="params">()</span></span> -&gt; <span class="type">Sealant</span>&lt;<span class="type">T</span>&gt; &#123; <span class="built_in">fatalError</span>() &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">inspect</span><span class="params">(<span class="number">_</span>: <span class="params">(Sealant&lt;T&gt;)</span></span></span> -&gt; <span class="type">Void</span>) &#123; <span class="built_in">fatalError</span>() &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">seal</span><span class="params">(<span class="number">_</span>: T)</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>Box&lt;T&gt;</code>更像是一个protocol</p>
<ul>
<li><code>inspect() -&gt; Sealant&lt;T&gt;</code>,利用它查询当前Box的状态<code>.pending</code>or<code>.resolved</code></li>
<li><code>inspect(_: (Sealant&lt;T&gt;) -&gt; Void)</code>这个方法完成操作，会根据它的closure参数中<code>Sealant&lt;T&gt;</code>的值的不同而不同</li>
<li><code>seal(_: T</code>用于向Box中封装值，利用这个方法，可以把box的状态从<code>.pending</code>改为<code>.resolved</code></li>
</ul>
<h4 id="SealedBox"><a href="#SealedBox" class="headerlink" title="SealedBox"></a>SealedBox</h4><p>SealedBox表示已经密封好的盒子，指的是状态已经为<code>.resolved</code>，其中已经包含了Promise的结果，且无法再对其进行修改。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SealedBox</span>&lt;<span class="title">T</span>&gt;: <span class="title">Box</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> value: <span class="type">T</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(value: <span class="type">T</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.value = value</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">inspect</span><span class="params">()</span></span> -&gt; <span class="type">Sealant</span>&lt;<span class="type">T</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> .resolved(value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建SealedBox时会直接传递一个value，表示把value密封在Box里，它唯一重写的方法<code>inspect</code>就是读取Box的状态，这个方法直接返回<code>.resolved(value)</code>。</p>
<h4 id="EmptyBox"><a href="#EmptyBox" class="headerlink" title="EmptyBox"></a>EmptyBox</h4><p>EmptyBox空的盒子，表示等待往里面装入值，PromiseKit中大部分的功能的实现都是使用EmptyBox来实现的。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmptyBox</span>&lt;<span class="title">T</span>&gt;: <span class="title">Box</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> sealant = <span class="type">Sealant</span>&lt;<span class="type">T</span>&gt;.pending(.<span class="keyword">init</span>()) <span class="comment">//可以理解为盒子的封条</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> barrier = <span class="type">DispatchQueue</span>(label: <span class="string">"org.promisekit.barrier"</span>, attributes: .concurrent)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  EmptyBox对Box的三个方法进行了重写:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">inspect</span><span class="params">()</span></span> -&gt; <span class="type">Sealant</span>&lt;<span class="type">T</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> rv: <span class="type">Sealant</span>&lt;<span class="type">T</span>&gt;!</span><br><span class="line">    barrier.sync &#123;</span><br><span class="line">        rv = <span class="keyword">self</span>.sealant</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rv</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个方法是获取盒子状态的inspect，用同步的方式获取当前的sealant。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">inspect</span><span class="params">(<span class="number">_</span> body: <span class="params">(Sealant&lt;T&gt;)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> sealed = <span class="literal">false</span></span><br><span class="line">    barrier.sync(flags: .barrier) &#123;</span><br><span class="line">        <span class="keyword">switch</span> sealant &#123;</span><br><span class="line">        <span class="keyword">case</span> .pending:</span><br><span class="line">            <span class="comment">// body will append to handlers, so we must stay barrier’d</span></span><br><span class="line">            body(sealant)</span><br><span class="line">        <span class="keyword">case</span> .resolved:</span><br><span class="line">            sealed = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> sealed &#123;</span><br><span class="line">        <span class="comment">// we do this outside the barrier to prevent potential deadlocks</span></span><br><span class="line">        <span class="comment">// it's safe because we never transition away from this state</span></span><br><span class="line">        body(sealant)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二个inspect方法是主要是把盒子的状态传递给body。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">seal</span><span class="params">(<span class="number">_</span> value: T)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> handlers: <span class="type">Handlers</span>&lt;<span class="type">T</span>&gt;!</span><br><span class="line">    barrier.sync(flags: .barrier) &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">case</span> .pending(<span class="keyword">let</span> _handlers) = <span class="keyword">self</span>.sealant <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span>  <span class="comment">// already fulfilled!</span></span><br><span class="line">        &#125;</span><br><span class="line">        handlers = _handlers</span><br><span class="line">        <span class="keyword">self</span>.sealant = .resolved(value)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> handlers = handlers &#123;</span><br><span class="line">        handlers.bodies.forEach&#123; $<span class="number">0</span>(value) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>seal</code>这个方法主要的作用：</p>
<ul>
<li>将盒子的状态从<code>.pending</code>编程<code>.resolved</code></li>
<li>把盒子中包含的值变成<code>value</code></li>
<li>通知之前注册过的关注这个变化的handlers</li>
</ul>
<p>在seal的实现里面<code>barrier.sync</code>的作用是只有当盒子的状态还是<code>.pending</code>，才可以执行密封的动作，如果盒子已经被密封上，则直接顺序调用所有的handlers。</p>
<h4 id="Resolver"><a href="#Resolver" class="headerlink" title="Resolver"></a>Resolver</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// An object for resolving promises</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Resolver</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> box: <span class="type">Box</span>&lt;<span class="type">Result</span>&lt;<span class="type">T</span>&gt;&gt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> box: <span class="type">Box</span>&lt;<span class="type">Result</span>&lt;<span class="type">T</span>&gt;&gt;) &#123;</span><br><span class="line">        <span class="keyword">self</span>.box = box</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">case</span> .pending = box.inspect() &#123;</span><br><span class="line">            conf.logHandler(.pendingPromiseDeallocated)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Resolver</code>包含了<code>Box</code>对象，而Box里面封装的是<code>Result&lt;T&gt;</code>，创建Promise的时候，我们用<code>fulfill</code>方法，向盒子里封装的，就是<code>case fulfill</code>。而使用<code>reject</code>，封装的就是<code>case rejected</code>。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">extension</span> <span class="title">Resolver</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// Fulfills the promise with the provided value</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">fulfill</span><span class="params">(<span class="number">_</span> value: T)</span></span> &#123;</span><br><span class="line">        box.seal(.fulfilled(value))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// Rejects the promise with the provided error</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">reject</span><span class="params">(<span class="number">_</span> error: Error)</span></span> &#123;</span><br><span class="line">        box.seal(.rejected(error))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的<code>Resolver</code>的扩展，就是用不同的值给<code>Resolver</code>内置的盒子封箱，除了具体的值外，还可以封装一个<code>Result&lt;T&gt;</code>、<code>Optional</code>，值得注意的是当传递的是nil，<code>Resolver</code>会自动把它解析成<code>.rejected</code>。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Resolves the promise with the provided value or error</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">resolve</span><span class="params">(<span class="number">_</span> obj: T?, <span class="number">_</span> error: Error?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">        reject(error)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> obj = obj &#123;</span><br><span class="line">        fulfill(obj)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        reject(<span class="type">PMKError</span>.invalidCallingConvention)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Fulfills the promise with the provided value unless the provided error is non-nil</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">resolve</span><span class="params">(<span class="number">_</span> obj: T, <span class="number">_</span> error: Error?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">        reject(error)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fulfill(obj)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="Promise-swift"><a href="#Promise-swift" class="headerlink" title="Promise.swift"></a>Promise.swift</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public final class Promise&lt;T&gt;: Thenable, CatchMixin &#123;</span><br><span class="line">    let box: Box&lt;Result&lt;T&gt;&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Promise遵守了两个协议<code>Thenable</code>和<code>CatchMixin</code>，<code>Thenable</code>提供了用于串联Promise的接口操作，跟<code>Resolver</code>一样，Promise也持有了<code>Box&lt;Result&lt;T&gt;&gt;</code>，这个属性会注入到<code>Resolver</code>，用于处理异步操作的结果。</p>
<p>Promise的resolver init方法允许我们指定一个动态生成“盒子值”的过程</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(resolver body: (<span class="type">Resolver</span>&lt;<span class="type">T</span>&gt;) <span class="keyword">throws</span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">  box = <span class="type">EmptyBox</span>()</span><br><span class="line">  <span class="keyword">let</span> resolver = <span class="type">Resolver</span>(box)</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> body(resolver)</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    resolver.reject(error)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是 example：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">load</span><span class="params">()</span></span> -&gt; <span class="type">Promise</span>&lt;<span class="type">UserSession</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="type">Promise</span>&lt;<span class="type">UserSession</span>&gt; &#123;</span><br><span class="line">    resolver <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> userSession = <span class="keyword">try</span> loadUserSession()</span><br><span class="line">      resolver.fulfill(userSession)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> &#123;</span><br><span class="line">      resolver.reject(error)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，这个根据loadUserSession的结果分别调用fullfill和reject的闭包，就是init的body参数。</p>
<p>在init(resolver:)的实现里，定义了一个EmptyBox对象，并用它创建了一个Resolver。然后用这个resolver对象作为body回调的参数，因此就可以load的中的闭包调用fulfill和reject的原因。</p>
<h4 id="Thenable"><a href="#Thenable" class="headerlink" title="Thenable"></a>Thenable</h4><p>Protocol Thenable，它约定了串联Promise对象的各种后续操作。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Thenable represents an asynchronous operation that can be chained.</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">Thenable</span>: <span class="title">class</span> </span>&#123;</span><br><span class="line">    <span class="comment">/// The type of the wrapped value</span></span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">T</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// `pipe` is immediately executed when this `Thenable` is resolved</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">pipe</span><span class="params">(to: @escaping<span class="params">(Result&lt;T&gt;)</span></span></span> -&gt; <span class="type">Void</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The resolved result or nil if pending.</span></span><br><span class="line">    <span class="keyword">var</span> result: <span class="type">Result</span>&lt;<span class="type">T</span>&gt;? &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关联类型T,可以理解为Promise中包装的类型，例如Promise<UserSession>中，T的类型就是UserSession。</p>
<p>在Promise.swift中可以看到var result: Result<T>?的实现逻辑，在Promise里，box中封装的类型是Result<T>，result的作用就是当”盒子”已经密封好的时候，把它的值取出来，如果是pending(没有密封好的时候)，否则返回nil。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// - See: `Thenable.result`</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">var</span> result: <span class="type">Result</span>&lt;<span class="type">T</span>&gt;? &#123;</span><br><span class="line">    <span class="keyword">switch</span> box.inspect() &#123;</span><br><span class="line">    <span class="keyword">case</span> .pending:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">case</span> .resolved(<span class="keyword">let</span> result):</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="Thenable的扩展"><a href="#Thenable的扩展" class="headerlink" title="Thenable的扩展"></a>Thenable的扩展</h4><p>通过Thenable的一系列扩展接口来实现”Promise”串联操作。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">then</span>&lt;U&gt;<span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    on: DispatchQueue? = conf.Q.<span class="built_in">map</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    flags: DispatchWorkItemFlags? = <span class="literal">nil</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="number">_</span> body: @escaping <span class="params">(<span class="keyword">Self</span>.T)</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">U</span>) -&gt; <span class="type">PromiseKit</span>.<span class="type">Promise</span>&lt;<span class="type">U</span>.<span class="type">T</span>&gt; <span class="keyword">where</span> <span class="type">U</span> : <span class="type">PromiseKit</span>.<span class="type">Thenable</span></span><br></pre></td></tr></table></figure>

<p><strong>on</strong>表示then串联的闭包执行的队列，它有一个默认值，是在主线程;</p>
<p><strong>flag</strong>表示队列中任务的配置，默认是nil;</p>
<p><strong>body</strong>就是在Promise对象之后，串联的closure，用Promise中封装的值作为闭包的参数，返回值U是一个新的遵从Thenable的类型，通常我们会返回一个新的Promise类型或者Guarantee对象。</p>
<p>then 函数返回的是一个新的Promise，这个Promise封装的值就是body参数中返回的U中的关联类型。</p>
<h4 id="then的实现"><a href="#then的实现" class="headerlink" title="then的实现"></a><code>then</code>的实现</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">then</span>&lt;U: Thenable&gt;<span class="params">(on: DispatchQueue? = conf.Q.<span class="built_in">map</span>, flags: DispatchWorkItemFlags? = <span class="literal">nil</span>, <span class="number">_</span> body: @escaping<span class="params">(T)</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">U</span>) -&gt; <span class="type">Promise</span>&lt;<span class="type">U</span>.<span class="type">T</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> rp = <span class="type">Promise</span>&lt;<span class="type">U</span>.<span class="type">T</span>&gt;(.pending)</span><br><span class="line">    pipe &#123;</span><br><span class="line">        <span class="keyword">switch</span> $<span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> .fulfilled(<span class="keyword">let</span> value):</span><br><span class="line">            on.async(flags: flags) &#123;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> rv = <span class="keyword">try</span> body(value)</span><br><span class="line">                    <span class="keyword">guard</span> rv !== rp <span class="keyword">else</span> &#123; <span class="keyword">throw</span> <span class="type">PMKError</span>.returnedSelf &#125;</span><br><span class="line">                    rv.pipe(to: rp.box.seal)</span><br><span class="line">                &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                    rp.box.seal(.rejected(error))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> .rejected(<span class="keyword">let</span> error):</span><br><span class="line">            rp.box.seal(.rejected(error))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先创建了一个返回值为Promise&lt;U.T&gt;:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let rp &#x3D; Promise&lt;U.T&gt;(.pending)  &#x2F;&#x2F; Promise&lt;U.T&gt;.init(.pending)</span><br></pre></td></tr></table></figure>

<p>.pending创建的不是一个Box，实际上是调用了以下的init方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">init</span>(<span class="number">_</span>: <span class="type">PMKUnambiguousInitializer</span>) &#123;</span><br><span class="line">  box = <span class="type">EmptyBox</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上方法创建了一个空的盒子，这个盒子将要封装的值类型就是Result&lt;U.T&gt;。</p>
<p>接下来就是pipe方法的调用，这个方法可以大概理解为当上游的Promise的期望达成之后，就调用then提供的闭包。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">pipe</span><span class="params">(to: @escaping<span class="params">(Result&lt;T&gt;)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> box.inspect() &#123; </span><br><span class="line">    <span class="keyword">case</span> .pending:</span><br><span class="line">        box.inspect &#123;</span><br><span class="line">            <span class="keyword">switch</span> $<span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> .pending(<span class="keyword">let</span> handlers):</span><br><span class="line">                handlers.append(to)</span><br><span class="line">            <span class="keyword">case</span> .resolved(<span class="keyword">let</span> value):</span><br><span class="line">                to(value)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> .resolved(<span class="keyword">let</span> value):</span><br><span class="line">        to(value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <code>box.inspect</code>读取了当前Promise中盒子的状态，如果box是resolved状态则直接把这个值传递给pipe的closure方法，如果是还在等待异步操作的结果，则调用box的另外的一个inspect版本，这个版本的 <code>box.inspect</code>会把当前Box的状态，传递给<code>inspect</code>的closure参数，并执行这个closure。</p>
<p>如果此时Promise还未得到期望的结果，就会把pipe的closure加入到handlers里面，否则则直接执行<code>to(value)</code>，所以当Promise一旦得到期望的结果就立即回调用pipe提供的closure执行。</p>
<p>在了解pipe函数之后，再来看一下then函数中对pipe的使用</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pipe &#123;</span><br><span class="line">    <span class="keyword">switch</span> $<span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> .fulfilled(<span class="keyword">let</span> value):</span><br><span class="line">        on.async(flags: flags) &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> rv = <span class="keyword">try</span> body(value)</span><br><span class="line">                <span class="keyword">guard</span> rv !== rp <span class="keyword">else</span> &#123; <span class="keyword">throw</span> <span class="type">PMKError</span>.returnedSelf &#125;</span><br><span class="line">                rv.pipe(to: rp.box.seal)</span><br><span class="line">            &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                rp.box.seal(.rejected(error))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> .rejected(<span class="keyword">let</span> error):</span><br><span class="line">        rp.box.seal(.rejected(error))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个pipe的闭包里面，首先会检查Promise对象传递过来的Result&lt;T&gt;对象，如果Result包含的是错误，则提取这个错误并封装到rp.box中，否则Result&lt;T&gt;对象包含的是成功执行的结果。do里面的body(value)就是在执行提供给then的closure。</p>
<p>重点是在对<code>rv.pipe(to: rp.box.seal)</code>的理解上，<code>rv.pipe</code>的closure参数，会在rv持有的box被密封的时候调用，而调用时，传递给<code>rp.box.seal</code>的参数就是<code>rv</code>被resolve时所封装的结果，即一个<code>Result&lt;U.T&gt;</code>对象，这就是可以一直wrapper串联各种操作的原因。</p>
<h4 id="Promise框架总结"><a href="#Promise框架总结" class="headerlink" title="Promise框架总结"></a>Promise框架总结</h4><h5 id="一-创建一个Promise-lt-T-gt-的步骤"><a href="#一-创建一个Promise-lt-T-gt-的步骤" class="headerlink" title="一.创建一个Promise&lt;T&gt;的步骤"></a>一.创建一个Promise&lt;T&gt;的步骤</h5><p><img src="https://raw.githubusercontent.com/CathyLy/imageForSource/master/2020/promise.png" alt="promise"></p>
<ul>
<li><p>首先调用了Promise的init方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(resolver body: (<span class="type">Resolver</span>&lt;<span class="type">T</span>&gt;) <span class="keyword">throws</span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    box = <span class="type">EmptyBox</span>()</span><br><span class="line">    <span class="keyword">let</span> resolver = <span class="type">Resolver</span>(box)</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> body(resolver)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        resolver.reject(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>其次在<code>init</code>方法中创建了一个<code>.pending</code>状态的空盒子，这个盒子有两个属性：一个是用于同步盒子状态的队列，另一个是处理Promise值的Handlers数组：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class EmptyBox&lt;T&gt;: Box&lt;T&gt; &#123;</span><br><span class="line">    private var sealant &#x3D; Sealant&lt;T&gt;.pending(Handlers.init())</span><br><span class="line">    private let barrier &#x3D; DispatchQueue(label: &quot;org.promisekit.barrier&quot;, attributes: .concurrent)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三，用上一步创建的盒子，创建一个<code>Resolver</code>对象，<code>Resolver</code>是PromiseKit为我们处理事件提供的接口。</p>
</li>
<li><p>第四，调用传递给<code>init</code>方法的闭包，这个闭包里面的代码有可能是同步执行也有可能是异步执行，具体取决于具体的逻辑，如果这个闭包抛出异常，PromiseKit会自动调用<code>resolver.reject(error)</code>，否则则需要在编写的闭包里面，根据代码执行的结果进行<code>resolver.fulfill(value)</code>或者<code>resolver.reject(error)</code>。这也是PromiseKit里面唯一有可能包含闭包嵌套的地方。</p>
</li>
<li><p>第五，无论是<code>fulfill</code>还是<code>reject</code>，它们背后的操作都是把特定的值封装在<code>Resolver</code>内部的盒子里。</p>
</li>
<li><p>最后，在<code>seal</code>的方法里面，如果盒子已经<code>resolved</code>，则直接返回，如果盒子的状态是<code>.pending</code>则把盒子设置为<code>.resolved</code>状态并一一调用每一个处理Promise期望值的handler。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">override func seal(_ value: T) &#123;</span><br><span class="line">    var handlers: Handlers&lt;T&gt;!</span><br><span class="line">    barrier.sync(flags: .barrier) &#123;</span><br><span class="line">        guard case .pending(let _handlers) &#x3D; self.sealant else &#123;</span><br><span class="line">            return  &#x2F;&#x2F; already fulfilled!</span><br><span class="line">        &#125;</span><br><span class="line">        handlers &#x3D; _handlers</span><br><span class="line">        self.sealant &#x3D; .resolved(value)</span><br><span class="line">    &#125;</span><br><span class="line">    if let handlers &#x3D; handlers &#123;</span><br><span class="line">        handlers.bodies.forEach&#123; $0(value) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h5 id="二-Promise的Wrapper操作"><a href="#二-Promise的Wrapper操作" class="headerlink" title="二.Promise的Wrapper操作"></a>二.Promise的Wrapper操作</h5><p><img src="https://raw.githubusercontent.com/CathyLy/imageForSource/master/2020/promise-wrapper.png" alt="image-20200121211615087"></p>
<p>上面的图重点在于<code>then</code>方法实现里面</p>
<ul>
<li><p>首先直接创建了它的返回值，一个<code>Promise&lt;U.T&gt;</code>对象，这个<code>Promise</code>里面包含的是一个等待密封的空盒子</p>
</li>
<li><p>创建好盒子之后，调用了<code>Promise.pipe</code>方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public func pipe(to: @escaping(Result&lt;T&gt;) -&gt; Void) &#123;</span><br><span class="line">    switch box.inspect() &#123;</span><br><span class="line">    case .pending:</span><br><span class="line">        box.inspect &#123;</span><br><span class="line">            switch $0 &#123;</span><br><span class="line">            case .pending(let handlers):</span><br><span class="line">                handlers.append(to)</span><br><span class="line">            case .resolved(let value):</span><br><span class="line">                to(value)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    case .resolved(let value):</span><br><span class="line">        to(value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法里面有5个关键点，前两个是两次调用了<code>box.inspect</code>方法，这两次调用都会向上游的<code>Promise.box</code>自带的队列里添加两个任务。</p>
<p>后三个是对<code>to</code>的引用，第一处是如果Promise是<code>.pending</code>则<code>pipe</code>的参数（闭包）添加到上游的<code>Promise.box</code>的<code>Handlers</code>的关联值中，后两处是如果Promise已经被<code>.resolved</code>则直接调用<code>pipe</code>的闭包参数</p>
</li>
<li><p>then的<code>pipe</code>回调中，有4处关键点：第一，<code>try body(value)</code>这是是真正调用外部给<code>then</code>传递的闭包的地方；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pipe &#123;</span><br><span class="line">  switch $0 &#123;</span><br><span class="line">  case .fulfilled(let value):</span><br><span class="line">    on.async(flags: flags) &#123;</span><br><span class="line">      do &#123;</span><br><span class="line">        let rv &#x3D; try body(value)</span><br><span class="line">        guard rv !&#x3D;&#x3D; rp else &#123; throw PMKError.returnedSelf &#125;</span><br><span class="line">        rv.pipe(to: rp.box.seal)</span><br><span class="line">      &#125; catch &#123;</span><br><span class="line">        rp.box.seal(.rejected(error))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  case .rejected(let error):</span><br><span class="line">    rp.box.seal(.rejected(error))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后三处分别以下三行代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rv.pipe(to: rp.box.seal)</span><br><span class="line">rp.box.seal(.rejected(error))</span><br><span class="line">rp.box.seal(.rejected(error))</span><br></pre></td></tr></table></figure>

<p><code>rv</code>是<code>body(value)</code>的返回值，<code>rp</code>是<code>then</code>要返回的<code>Promise</code>对象，后两行代码主要功能是无论上游<code>Promise</code>发生了什么错误，还是说外部提供给<code>then</code>的闭包发生了异常，都要给<code>rp</code>的盒子密封上错误的value。</p>
<p>如果没有发生任何异常，<code>rp</code>中的值则依赖<code>body</code>的实现：如果<code>body</code>中调用<code>fulfill</code>就封装成功的值，调用<code>reject</code>就封装错误的值。</p>
<p>最后，把<code>rp</code>的封箱过程，交由<code>rv</code>来处理，等<code>rv</code>持有的盒子被密封了，就可以返回了。</p>
</li>
</ul>
<h4 id="when"><a href="#when" class="headerlink" title="when"></a>when</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> getUserAssets = getUserAssets(session: session)</span><br><span class="line"><span class="keyword">let</span> getUserMarginAssetsDetails = getMarginAccountDetails(session: session)</span><br><span class="line"><span class="keyword">let</span> getUserMarginCoeff = getUserMarginCoeff(session: session)</span><br><span class="line"><span class="keyword">let</span> getAccountProfit =getAccountProfit(session: session, period: time)</span><br><span class="line"></span><br><span class="line">when(fulfilled: getUserAssets, getUserMarginAssetsDetails, getUserMarginCoeff, getAccountProfit)</span><br><span class="line">.<span class="built_in">map</span>(&#123; (userAssets, userMarginAssetsDetails, userMarginCoeff, profits) -&gt; <span class="type">MarginFundsState</span> <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> <span class="type">MarginFundsState</span>(userAssets: userAssets, userMarginAssetsDetails: userMarginAssetsDetails, userMarginCoeff: userMarginCoeff, profits: profits)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>when</code>表示多个异步操作同时处理，当<code>when</code>中的操作都完成时再返回Promise结果。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">when</span>&lt;U: Thenable&gt;<span class="params">(fulfilled thenables: [U])</span></span> -&gt; <span class="type">Promise</span>&lt;[<span class="type">U</span>.<span class="type">T</span>]&gt; </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">when</span>&lt;T&gt;<span class="params">(resolved promises: Promise&lt;T&gt;...)</span></span> -&gt; <span class="type">Guarantee</span>&lt;[<span class="type">Result</span>&lt;<span class="type">T</span>&gt;]&gt;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">race</span>&lt;U: Thenable&gt;<span class="params">(<span class="number">_</span> thenables: U...)</span></span> -&gt; <span class="type">Promise</span>&lt;<span class="type">U</span>.<span class="type">T</span>&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>when(fulfilled:)</code>在所有异步操作都执行完成之后再回调，</li>
<li><code>when(resolved: )</code>是使一个或多个Promise失败也会等待，此<code>when</code>变体返回的值是一个<code>[Result&lt;T&gt;]</code>的数组，所有要保证是相同的泛型。</li>
<li><code>race()</code>表示的是只有有一个异步操作完成则立刻调用<code>then</code>的回调，其他没有执行完毕的异步操作会继续执行，不会停止。</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Wait for all promises in a set to fulfill.</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">when</span>&lt;U: Thenable, V: Thenable, W: Thenable, X: Thenable, Y: Thenable&gt;<span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    fulfilled pu: U, <span class="number">_</span> pv: V, <span class="number">_</span> pw: W, <span class="number">_</span> px: X, <span class="number">_</span> py: Y)</span></span> -&gt; <span class="type">Promise</span>&lt;(<span class="type">U</span>.<span class="type">T</span>, <span class="type">V</span>.<span class="type">T</span>, <span class="type">W</span>.<span class="type">T</span>, <span class="type">X</span>.<span class="type">T</span>, <span class="type">Y</span>.<span class="type">T</span>)&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> _when([pu.asVoid(), pv.asVoid(), pw.asVoid(), px.asVoid(), py.asVoid()])</span><br><span class="line">        .<span class="built_in">map</span>(on: <span class="literal">nil</span>) &#123; (pu.value!, pv.value!, pw.value!, px.value!, py.value!) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的when的函数可以看出，<code>when(fulfilled:)</code>PromiseKit目前最多支持同时五个异步不同Promise操作。</p>
<p>以上就是整个PromiseKit的源码分析。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">liututu1213</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/blog/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/blog/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liututu1213</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
